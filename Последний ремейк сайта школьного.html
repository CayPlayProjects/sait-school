<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Набережные Челны - Викторина, Фототур и Видео</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Все предыдущие стили остаются без изменений */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --chelny-blue: #0054A6;
            --chelny-light-blue: #4A90E2;
            --chelny-green: #2E8B57;
            --chelny-gold: #FFD700;
            --chelny-red: #C62828;
            --chelny-white: #FFFFFF;
            --chelny-dark: #1A3A5F;
            
            /* Светлая тема */
            --bg-color: #f8fafc;
            --text-color: #1e293b;
            --card-bg: rgba(255, 255, 255, 0.95);
            --card-border: rgba(0, 0, 0, 0.08);
            --shadow-color: rgba(0, 0, 0, 0.05);
            --section-bg: rgba(248, 250, 252, 0.95);
            --hover-bg: rgba(0, 84, 166, 0.05);
        }

        body.dark-theme {
            /* Темная тема - менее темная, с лучшей контрастностью */
            --bg-color: #1e293b;
            --text-color: #f1f5f9;
            --card-bg: rgba(30, 41, 59, 0.95);
            --card-border: rgba(255, 255, 255, 0.12);
            --shadow-color: rgba(0, 0, 0, 0.2);
            --section-bg: rgba(30, 41, 59, 0.95);
            --hover-bg: rgba(255, 255, 255, 0.08);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            line-height: 1.7;
            min-height: 100vh;
            overflow-x: hidden;
            transition: all 0.3s ease;
            font-size: 18px; /* Увеличен с 16px */
            font-weight: 400;
            letter-spacing: 0.01em; /* Небольшой кернинг для лучшей читаемости */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 25px; /* Увеличен паддинг */
        }

        /* Добавляем новые стили для видео тура и других функций */

        /* Стили для видео контейнера */
        .video-container {
            position: relative;
            width: 100%;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
            background: #000;
        }

        .video-wrapper {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 соотношение */
            height: 0;
        }

        .video-wrapper iframe,
        .video-wrapper video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }

        .video-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: var(--card-bg);
            border-top: 1px solid var(--card-border);
        }

        .fullscreen-btn {
            background: linear-gradient(135deg, var(--chelny-blue), var(--chelny-light-blue));
            color: white;
            border: none;
            padding: 12px 24px; /* Увеличен паддинг */
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 1.1rem; /* Увеличен шрифт */
        }

        .fullscreen-btn:hover {
            background: linear-gradient(135deg, var(--chelny-green), #34A853);
            transform: translateY(-2px);
        }

        .video-info {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        /* Стили для кнопки скрытия/показа интересного факта */
        .toggle-fact-btn {
            background: linear-gradient(135deg, #FF9800, #F57C00);
            color: white;
            border: none;
            padding: 12px 24px; /* Увеличен паддинг */
            border-radius: 25px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            margin-top: 15px;
            transition: all 0.3s ease;
            font-size: 1.1rem; /* Увеличен шрифт */
        }

        .toggle-fact-btn:hover {
            background: linear-gradient(135deg, #F57C00, #E65100);
            transform: translateY(-2px);
        }

        .location-fact {
            transition: all 0.3s ease;
            max-height: 500px;
            overflow: hidden;
        }

        .location-fact.hidden {
            max-height: 0;
            opacity: 0;
            margin: 0;
            padding: 0;
        }

        /* Стили для видео в полноэкранном режиме */
        .fullscreen-video {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            z-index: 4000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .fullscreen-video.active {
            display: flex;
        }

        .fullscreen-video-content {
            width: 90%;
            height: 90%;
            position: relative;
        }

        .close-fullscreen {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--chelny-red);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 4001;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-fullscreen:hover {
            transform: rotate(90deg);
            background: #b71c1c;
        }

        /* Обновляем стили для редактирования ответа на вопрос */
        .edit-question-info {
            margin-top: 20px;
            padding: 15px;
            background: var(--card-bg);
            border-radius: 10px;
            border: 1px solid var(--card-border);
        }

        .edit-question-info textarea {
            width: 100%;
            min-height: 80px;
            padding: 10px;
            border: 1px solid var(--card-border);
            border-radius: 5px;
            background: var(--bg-color);
            color: var(--text-color);
            font-size: 1.1rem; /* Увеличен шрифт */
        }

        /* Обновляем тему видео тура */
        .theme-icon-video {
            color: #9C27B0;
        }

        /* Панель управления - добавляем кнопку для видео */
        .video-btn {
            background: linear-gradient(135deg, #9C27B0, #7B1FA2);
        }

        .video-btn:hover {
            background: linear-gradient(135deg, #7B1FA2, #6A1B9A);
        }

        /* В модальном окне редактирования добавляем поля для видео */
        .edit-video-url {
            margin-top: 10px;
        }

        /* Остальные существующие стили остаются без изменений */
        .controls-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: rgba(var(--card-bg), 0.9);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 20px var(--shadow-color);
            border: 1px solid var(--card-border);
        }

        .control-btn {
            background: linear-gradient(135deg, var(--chelny-blue), var(--chelny-light-blue));
            color: var(--chelny-white);
            border: none;
            padding: 16px 32px; /* Увеличен паддинг */
            border-radius: 30px;
            font-size: 1.1rem; /* Увеличен шрифт */
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(0, 84, 166, 0.4);
        }

        .control-btn:hover {
            background: linear-gradient(135deg, var(--chelny-green), #34A853);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(46, 139, 87, 0.4);
        }

        .admin-btn {
            background: linear-gradient(135deg, #9C27B0, #7B1FA2);
        }

        .admin-btn:hover {
            background: linear-gradient(135deg, #7B1FA2, #6A1B9A);
        }

        .optimize-btn {
            background: linear-gradient(135deg, #FF9800, #F57C00);
        }

        .optimize-btn:hover {
            background: linear-gradient(135deg, #F57C00, #E65100);
        }

        .test-image-btn {
            background: linear-gradient(135deg, #2196F3, #1976D2);
        }

        .test-image-btn:hover {
            background: linear-gradient(135deg, #1976D2, #1565C0);
        }

        /* Стили для кнопки сохранения */
        .save-btn {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
        }
        
        .save-btn:hover {
            background: linear-gradient(135deg, #2E7D32, #1B5E20);
        }

        body.optimized-mode {
            --card-bg: var(--bg-color);
            --section-bg: var(--bg-color);
            --shadow-color: transparent;
            --hover-bg: transparent;
        }

        body.optimized-mode .theme-card,
        body.optimized-mode .option,
        body.optimized-mode .question-container,
        body.optimized-mode .theme-group,
        body.optimized-mode .history-panel,
        body.optimized-mode footer {
            box-shadow: none !important;
            border: 1px solid var(--card-border) !important;
            transform: none !important;
            transition: none !important;
        }

        body.optimized-mode .theme-card:hover,
        body.optimized-mode .option:hover {
            transform: none !important;
            border-color: var(--chelny-blue) !important;
        }

        body.optimized-mode .edit-modal {
            padding: 5px;
        }

        body.optimized-mode .edit-panel {
            margin: 5px auto;
            padding: 15px;
        }

        body.optimized-mode .controls-panel {
            position: static;
            margin: 10px auto;
            flex-direction: column;
            background: var(--bg-color);
            border: 1px solid var(--card-border);
        }

        body.optimized-mode .optimize-btn {
            background: linear-gradient(135deg, #4CAF50, #388E3C);
        }

        body.optimized-mode .optimize-btn:hover {
            background: linear-gradient(135deg, #388E3C, #2E7D32);
        }

        body.optimized-mode * {
            animation-duration: 0.1s !important;
            transition-duration: 0.1s !important;
        }

        /* Модальное окно редактирования */
        .edit-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            padding: 20px;
            overflow-y: auto;
        }

        .edit-modal.active {
            display: block;
        }

        .edit-panel {
            background: var(--section-bg);
            border-radius: 20px;
            padding: 30px;
            max-width: 800px;
            margin: 20px auto;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            border: 3px solid var(--chelny-blue);
        }

        .edit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--chelny-green);
        }

        .edit-title {
            font-size: 2rem; /* Увеличен */
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .close-edit {
            background: var(--chelny-red);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .close-edit:hover {
            transform: rotate(90deg);
            background: #b71c1c;
        }

        .edit-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .edit-tab {
            padding: 14px 28px; /* Увеличен паддинг */
            background: var(--card-bg);
            border: 2px solid var(--card-border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            color: var(--text-color);
            font-size: 1.1rem; /* Увеличен шрифт */
        }

        .edit-tab:hover {
            border-color: var(--chelny-blue);
            transform: translateY(-2px);
        }

        .edit-tab.active {
            background: linear-gradient(135deg, var(--chelny-blue), var(--chelny-light-blue));
            color: white;
            border-color: var(--chelny-blue);
        }

        .edit-section {
            display: none;
        }

        .edit-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
            font-size: 1.1rem; /* Увеличен шрифт */
        }

        .form-control {
            width: 100%;
            padding: 14px; /* Увеличен паддинг */
            border: 2px solid var(--card-border);
            border-radius: 10px;
            background: var(--card-bg);
            color: var(--text-color);
            font-size: 1.1rem; /* Увеличен шрифт */
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--chelny-blue);
            box-shadow: 0 0 0 3px rgba(0, 84, 166, 0.2);
        }

        .edit-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .option-row {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
            padding: 15px;
            background: var(--card-bg);
            border-radius: 10px;
            border: 1px solid var(--card-border);
        }

        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 14px 28px; /* Увеличен паддинг */
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1rem; /* Увеличен шрифт */
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--chelny-blue), var(--chelny-light-blue));
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--chelny-light-blue), var(--chelny-blue));
            transform: translateY(-2px);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--chelny-green), #34A853);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #34A853, var(--chelny-green));
            transform: translateY(-2px);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--chelny-red), #D32F2F);
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #D32F2F, var(--chelny-red));
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--card-bg);
            color: var(--text-color);
            border: 2px solid var(--card-border);
        }

        .btn-secondary:hover {
            background: var(--hover-bg);
            border-color: var(--chelny-blue);
            transform: translateY(-2px);
        }

        .btn-small {
            padding: 8px 16px; /* Увеличен паддинг */
            font-size: 1rem; /* Увеличен шрифт */
        }

        .status-message {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            display: none;
            font-size: 1.1rem; /* Увеличен шрифт */
        }

        .status-success {
            background: rgba(46, 139, 87, 0.2);
            color: var(--chelny-green);
            border: 2px solid var(--chelny-green);
        }

        .status-error {
            background: rgba(198, 40, 40, 0.2);
            color: var(--chelny-red);
            border: 2px solid var(--chelny-red);
        }

        /* Стили для бэкапа данных */
        .backup-info {
            font-size: 0.9rem;
            color: var(--text-color);
            opacity: 0.8;
            margin-top: 10px;
            padding: 15px;
            background: rgba(76, 175, 80, 0.1);
            border-radius: 10px;
            border-left: 3px solid #4CAF50;
            line-height: 1.5;
        }

        .backup-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .backup-btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 200px;
            justify-content: center;
        }

        .download-btn {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
        }

        .download-btn:hover {
            background: linear-gradient(135deg, #1976D2, #1565C0);
            transform: translateY(-2px);
        }

        .upload-btn {
            background: linear-gradient(135deg, #FF9800, #F57C00);
            color: white;
        }

        .upload-btn:hover {
            background: linear-gradient(135deg, #F57C00, #E65100);
            transform: translateY(-2px);
        }

        .import-section {
            display: none;
            margin-top: 25px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 2px dashed var(--card-border);
        }

        .import-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .file-input-wrapper {
            margin: 20px 0;
        }

        .file-input {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--card-border);
            border-radius: 10px;
            background: var(--card-bg);
            color: var(--text-color);
            font-size: 1rem;
        }

        .file-input:focus {
            outline: none;
            border-color: var(--chelny-blue);
        }

        /* Остальные стили */
        .header-container {
            display: flex;
            align-items: center;
            gap: 40px;
            margin-bottom: 40px;
            padding-top: 20px;
        }

        .coat-of-arms {
            flex: 0 0 180px;
            height: 220px;
            background: var(--card-bg);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 8px 20px var(--shadow-color);
            border: 4px solid var(--card-border);
            position: relative;
            overflow: hidden;
        }

        .coat-of-arms img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            border-radius: 5px;
        }

        .header-content {
            flex: 1;
        }

        .anniversary-text {
            font-size: 4.5rem; /* Увеличен с 4rem */
            font-weight: 800;
            margin-bottom: 15px;
            color: var(--chelny-blue);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .city-name {
            font-size: 2.5rem; /* Увеличен с 2.2rem */
            color: var(--chelny-blue);
            margin-bottom: 20px;
            font-weight: 700;
        }

        .subtitle {
            font-size: 1.8rem; /* Увеличен с 1.6rem */
            color: var(--text-color);
            opacity: 0.9;
            font-weight: 500;
            line-height: 1.5;
            max-width: 800px;
        }

        .history-btn {
            background: linear-gradient(135deg, var(--chelny-blue), var(--chelny-light-blue));
            color: var(--chelny-white);
            border: none;
            padding: 16px 32px; /* Увеличен паддинг */
            border-radius: 30px;
            font-size: 1.1rem; /* Увеличен шрифт */
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 30px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(0, 84, 166, 0.4);
        }

        .history-btn:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 84, 166, 0.6);
        }

        .history-panel {
            background: var(--section-bg);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 40px;
            box-shadow: 0 10px 30px var(--shadow-color);
            border: 3px solid var(--chelny-blue);
            display: none;
        }

        .history-panel.active {
            display: block;
        }

        .theme-groups {
            display: flex;
            flex-direction: column;
            gap: 40px;
            margin-bottom: 50px;
        }

        .theme-group {
            background: var(--section-bg);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 25px var(--shadow-color);
            border: 2px solid var(--card-border);
            transition: all 0.3s ease;
        }

        .group-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--chelny-green);
        }

        .group-title {
            font-size: 2rem;
            color: var(--text-color);
            font-weight: 700;
        }

        .theme-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        @media (max-width: 1200px) {
            .theme-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .theme-grid {
                grid-template-columns: 1fr;
            }
            
            .controls-panel {
                position: static;
                margin: 20px auto;
                flex-direction: row;
                justify-content: center;
                flex-wrap: wrap;
                max-width: 90%;
            }
            
            .anniversary-text {
                font-size: 3rem; /* Адаптивный размер */
            }
            
            .city-name {
                font-size: 2rem;
            }
            
            .subtitle {
                font-size: 1.5rem;
            }
            
            body {
                font-size: 16px; /* Немного уменьшаем для мобильных */
            }
            
            .question-text {
                font-size: 1.6rem;
                padding: 20px;
            }
            
            .option {
                font-size: 1.1rem;
                padding: 20px;
            }
            
            .location-title {
                font-size: 1.8rem;
            }
            
            .location-description {
                font-size: 1.15rem;
            }
            
            .backup-actions {
                flex-direction: column;
            }
            
            .backup-btn {
                width: 100%;
                min-width: auto;
            }
            
            body.optimized-mode .theme-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            body.optimized-mode .options-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            body.optimized-mode .header-container {
                flex-direction: column;
                gap: 20px;
            }
            
            body.optimized-mode .coat-of-arms {
                flex: 0 0 120px;
                height: 150px;
            }
            
            body.optimized-mode .question-content {
                flex-direction: column;
            }
            
            body.optimized-mode .question-image {
                flex: 0 0 auto;
                width: 100%;
            }
        }

        .theme-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 30px 25px; /* Увеличен вертикальный паддинг */
            text-align: center;
            box-shadow: 0 5px 15px var(--shadow-color);
            border: 2px solid var(--card-border);
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 200px; /* Увеличен с 180px */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .theme-card:hover {
            transform: translateY(-10px) scale(1.05);
            box-shadow: 0 15px 30px rgba(0, 84, 166, 0.4);
            border-color: var(--chelny-green);
        }

        .theme-icon {
            font-size: 2.5rem;
            color: var(--chelny-blue);
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        /* Улучшаем отображение иконок в темной теме */
        body.dark-theme .theme-icon {
            color: #60a5fa; /* Более светлые иконки */
        }

        body.dark-theme .theme-icon-video {
            color: #d8b4fe; /* Специальный цвет для видео иконок */
        }

        .theme-title {
            font-size: 1.6rem; /* Увеличен с 1.4rem */
            color: var(--text-color);
            font-weight: 700; /* Более жирный шрифт */
            margin-bottom: 12px;
        }

        .theme-desc {
            font-size: 1.15rem; /* Увеличен с 1rem */
            color: var(--text-color);
            opacity: 0.85; /* Лучшая читаемость */
            line-height: 1.5;
        }

        /* Улучшаем читаемость мелкого текста */
        body.dark-theme small,
        body.dark-theme .theme-desc,
        body.dark-theme .detail-label,
        body.dark-theme .detail-value,
        body.dark-theme .form-control,
        body.dark-theme textarea {
            color: #e2e8f0;
            opacity: 0.9;
        }

        .content-section {
            display: none;
            margin-bottom: 50px;
        }

        .content-section.active {
            display: block;
        }

        footer {
            background: var(--section-bg);
            padding: 40px;
            border-radius: 25px;
            text-align: center;
            margin-top: 60px;
            color: var(--text-color);
            box-shadow: 0 10px 30px var(--shadow-color);
        }

        .footer-title {
            font-size: 2.2rem; /* Увеличен с 2rem */
            margin-bottom: 25px;
            font-weight: 800;
            color: var(--text-color);
        }

        footer p {
            font-size: 1.2rem; /* Увеличен */
            margin-bottom: 15px;
            opacity: 0.9;
        }

        .score-display {
            font-size: 1.3rem; /* Увеличен */
            font-weight: 600;
        }

        /* Стили для фототура и видео тура */
        .photo-tour-container,
        .video-tour-container {
            background: var(--section-bg);
            border-radius: 25px;
            padding: 40px;
            box-shadow: 0 15px 35px var(--shadow-color);
            border: 3px solid var(--chelny-blue);
        }

        .photo-tour-header,
        .video-tour-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid var(--chelny-green);
        }

        .tour-title {
            font-size: 2rem;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .tour-progress {
            font-size: 1.2rem;
            color: var(--chelny-blue);
            font-weight: 600;
            background: var(--card-bg);
            padding: 10px 20px;
            border-radius: 30px;
            border: 2px solid var(--chelny-blue);
        }

        .tour-content {
            display: flex;
            gap: 40px;
            margin-bottom: 40px;
            align-items: flex-start;
        }

        @media (max-width: 992px) {
            .tour-content {
                flex-direction: column;
            }
        }

        .tour-image-container {
            flex: 0 0 400px;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px var(--shadow-color);
            position: relative;
        }

        .tour-image {
            width: 100%;
            height: 300px;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .tour-image:hover {
            transform: scale(1.05);
        }

        .tour-info {
            flex: 1;
        }

        .location-title {
            font-size: 2.2rem; /* Увеличен с 2rem */
            color: var(--chelny-blue);
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--chelny-green);
        }

        .location-description {
            font-size: 1.35rem; /* Увеличен с 1.2rem */
            line-height: 1.8;
            margin-bottom: 30px;
            padding: 25px;
            background: var(--card-bg);
            border-radius: 15px;
            border-left: 6px solid var(--chelny-blue);
        }

        .location-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .detail-item {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid var(--card-border);
        }

        .detail-label {
            font-size: 1rem; /* Увеличен с 0.9rem */
            color: var(--text-color);
            opacity: 0.8;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .detail-value {
            font-size: 1.35rem; /* Увеличен с 1.2rem */
            font-weight: 700;
            color: var(--chelny-blue);
        }

        /* Дополнительные улучшения для контрастности */
        body.dark-theme a,
        body.dark-theme .chelny-blue {
            color: #60a5fa; /* Более светлый синий для темной темы */
        }

        body.dark-theme .chelny-green {
            color: #4ade80; /* Более светлый зеленый для темной темы */
        }

        body.dark-theme .answer-feedback.correct {
            background: rgba(46, 139, 87, 0.25); /* Более контрастный фон */
        }

        body.dark-theme .answer-feedback.incorrect {
            background: rgba(198, 40, 40, 0.25); /* Более контрастный фон */
        }

        .tour-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid var(--card-border);
        }

        .tour-btn {
            background: linear-gradient(135deg, var(--chelny-blue), var(--chelny-light-blue));
            color: var(--chelny-white);
            border: none;
            padding: 16px 32px; /* Увеличен паддинг */
            border-radius: 30px;
            font-size: 1.1rem; /* Увеличен шрифт */
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(0, 84, 166, 0.4);
        }

        .tour-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, var(--chelny-green), #34A853);
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(46, 139, 87, 0.4);
        }

        .tour-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .tour-thumbnails {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            overflow-x: auto;
            padding: 10px;
            scrollbar-width: thin;
        }

        .tour-thumbnail {
            flex: 0 0 120px;
            height: 80px;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            opacity: 0.6;
        }

        .tour-thumbnail:hover {
            transform: translateY(-5px);
            opacity: 0.8;
        }

        .tour-thumbnail.active {
            border-color: var(--chelny-green);
            opacity: 1;
            box-shadow: 0 5px 15px rgba(46, 139, 87, 0.3);
        }

        .tour-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .tour-map-btn {
            background: linear-gradient(135deg, var(--chelny-green), #34A853);
            margin-left: auto;
        }

        .tour-map-btn:hover {
            background: linear-gradient(135deg, var(--chelny-blue), var(--chelny-light-blue));
        }

        /* Карта фототур-локаций */
        .tour-map-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 3000;
            padding: 20px;
            overflow-y: auto;
        }

        .tour-map-modal.active {
            display: block;
        }

        .tour-map-container {
            background: var(--section-bg);
            border-radius: 20px;
            padding: 30px;
            max-width: 1000px;
            margin: 20px auto;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            border: 3px solid var(--chelny-blue);
        }

        .map-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--chelny-green);
        }

        .map-title {
            font-size: 2rem;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .close-map {
            background: var(--chelny-red);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .close-map:hover {
            transform: rotate(90deg);
            background: #b71c1c;
        }

        .map-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .map-location {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid var(--card-border);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .map-location:hover {
            border-color: var(--chelny-green);
            transform: translateY(-5px);
            box-shadow: 0 10px 20px var(--shadow-color);
        }

        .map-location.active {
            border-color: var(--chelny-blue);
            background: linear-gradient(135deg, rgba(0, 84, 166, 0.1), rgba(74, 144, 226, 0.1));
        }

        .map-location-visited {
            border-color: var(--chelny-green);
            background: linear-gradient(135deg, rgba(46, 139, 87, 0.1), rgba(52, 168, 83, 0.1));
        }

        .map-location-number {
            display: inline-block;
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, var(--chelny-blue), var(--chelny-light-blue));
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            font-weight: bold;
            margin-right: 10px;
        }

        .map-location-title {
            font-size: 1.2rem;
            color: var(--text-color);
            margin-bottom: 10px;
        }

        .map-location-desc {
            font-size: 0.9rem;
            color: var(--text-color);
            opacity: 0.7;
        }

        /* Стили для викторины */
        .question-container {
            background: var(--section-bg);
            border-radius: 25px;
            padding: 40px;
            box-shadow: 0 15px 35px var(--shadow-color);
            border: 3px solid var(--chelny-blue);
        }

        .question-content {
            display: flex;
            gap: 40px;
            margin-bottom: 40px;
            align-items: flex-start;
        }

        @media (max-width: 768px) {
            .question-content {
                flex-direction: column;
            }
        }

        .question-image {
            flex: 0 0 300px;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 8px 25px var(--shadow-color);
        }

        .question-image img {
            width: 100%;
            height: 250px;
            object-fit: contain;
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            padding: 5px;
            border: 2px solid var(--card-border);
            transition: all 0.3s ease;
        }

        .question-image img:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 15px var(--shadow-color);
        }

        .question-text {
            font-size: 2rem; /* Увеличен с 1.8rem */
            color: var(--text-color);
            margin-bottom: 30px;
            line-height: 1.6; /* Лучший интерлиньяж */
            padding: 25px;
            background: var(--card-bg);
            border-radius: 15px;
            border-left: 6px solid var(--chelny-green);
            box-shadow: 0 4px 20px var(--shadow-color);
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }

        @media (max-width: 768px) {
            .options-grid {
                grid-template-columns: 1fr;
            }
        }

        .option {
            background: var(--card-bg);
            padding: 30px; /* Увеличен паддинг */
            border-radius: 15px;
            border: 2px solid var(--card-border);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 20px;
            font-size: 1.25rem; /* Увеличен с 1.1rem */
            box-shadow: 0 4px 15px var(--shadow-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .option:hover {
            border-color: var(--chelny-blue);
            transform: translateX(10px) scale(1.02);
            box-shadow: 0 8px 25px rgba(0, 84, 166, 0.4);
            background: var(--hover-bg);
        }

        .option.selected {
            border-color: var(--chelny-blue);
            background: linear-gradient(135deg, rgba(0, 84, 166, 0.2), rgba(0, 84, 166, 0.1));
            transform: translateX(5px);
        }

        .option.correct {
            border-color: var(--chelny-green);
            background: linear-gradient(135deg, rgba(46, 139, 87, 0.2), rgba(46, 139, 87, 0.1));
        }

        .option.incorrect {
            border-color: var(--chelny-red);
            background: linear-gradient(135deg, rgba(198, 40, 40, 0.2), rgba(198, 40, 40, 0.1));
        }

        .option-letter {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px; /* Увеличен размер */
            height: 48px; /* Увеличен размер */
            background: linear-gradient(135deg, var(--chelny-blue), var(--chelny-light-blue));
            color: var(--chelny-white);
            border-radius: 50%;
            font-weight: 800;
            font-size: 1.3rem; /* Увеличен шрифт */
            flex-shrink: 0;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid var(--card-border);
        }

        .nav-btn {
            background: linear-gradient(135deg, var(--chelny-blue), var(--chelny-light-blue));
            color: var(--chelny-white);
            border: none;
            padding: 16px 32px; /* Увеличен паддинг */
            border-radius: 30px;
            font-size: 1.1rem; /* Увеличен шрифт */
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(0, 84, 166, 0.4);
        }

        .nav-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, var(--chelny-green), #34A853);
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(46, 139, 87, 0.4);
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .submit-btn {
            background: linear-gradient(135deg, var(--chelny-green), #34A853);
        }

        .submit-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, var(--chelny-blue), var(--chelny-light-blue));
        }

        .continue-btn {
            background: linear-gradient(135deg, var(--chelny-green), #34A853);
            color: white;
        }

        .continue-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #34A853, var(--chelny-green));
        }

        /* Кнопка "Проверить ответ" */
        .check-answer-btn {
            background: linear-gradient(135deg, #9C27B0, #7B1FA2);
            color: white;
        }

        .check-answer-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #7B1FA2, #6A1B9A);
        }

        /* Информация о правильности ответа */
        .answer-feedback {
            margin: 20px 0;
            padding: 20px;
            border-radius: 15px;
            display: none;
        }

        .answer-feedback.correct {
            background: linear-gradient(135deg, rgba(46, 139, 87, 0.1), rgba(52, 168, 83, 0.1));
            border: 2px solid var(--chelny-green);
            color: var(--chelny-green);
        }

        .answer-feedback.incorrect {
            background: linear-gradient(135deg, rgba(198, 40, 40, 0.1), rgba(211, 47, 47, 0.1));
            border: 2px solid var(--chelny-red);
            color: var(--chelny-red);
        }

        .answer-feedback.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .feedback-icon {
            font-size: 1.5rem;
            margin-right: 10px;
        }

        .image-preview {
            margin-top: 10px;
            border: 2px solid var(--card-border);
            border-radius: 10px;
            overflow: hidden;
            max-width: 300px;
            display: none;
        }

        .image-preview img {
            width: 100%;
            height: auto;
            display: block;
        }

        .image-preview.active {
            display: block;
        }
    </style>
</head>
<body class="light-bg">
    <div class="container">
        <!-- Панель управления -->
        <div class="controls-panel">
            <button class="control-btn" id="themeToggle">
                <i class="fas fa-moon"></i> Тёмная тема
            </button>
            <button class="control-btn admin-btn" id="editBtn">
                <i class="fas fa-edit"></i> Редактировать
            </button>
            <button class="control-btn optimize-btn" id="optimizeBtn">
                <i class="fas fa-tachometer-alt"></i> Режим экономии
            </button>
            <!-- Новая кнопка для сохранения данных -->
            <button class="control-btn save-btn" onclick="openBackupModal()">
                <i class="fas fa-save"></i> Сохранить данные
            </button>
            <button class="control-btn" onclick="clearAppCache()" style="background: #f44336;">
                <i class="fas fa-trash"></i> Очистить кэш
            </button>
        </div>

        <!-- Модальное окно бэкапа -->
        <div class="edit-modal" id="backupModal">
            <div class="edit-panel">
                <div class="edit-header">
                    <h2 class="edit-title"><i class="fas fa-download"></i> Сохранение данных</h2>
                    <button class="close-edit" onclick="closeBackupModal()">×</button>
                </div>
                
                <div class="backup-info">
                    <p><strong>Сохранение данных:</strong> Вы можете скачать все ваши изменения (вопросы, локации, видео, историю) в один HTML-файл. Этот файл можно открыть на любом устройстве без подключения к интернету.</p>
                </div>
                
                <div class="backup-actions">
                    <button class="backup-btn download-btn" onclick="downloadBackup()">
                        <i class="fas fa-file-download"></i> Скачать HTML-файл
                    </button>
                    <button class="backup-btn upload-btn" onclick="toggleImportSection()">
                        <i class="fas fa-file-upload"></i> Загрузить из файла
                    </button>
                </div>
                
                <div class="import-section" id="importSection">
                    <h4><i class="fas fa-upload"></i> Загрузка данных из файла</h4>
                    <p style="margin-bottom: 15px;">Выберите ранее сохраненный HTML-файл для восстановления данных:</p>
                    
                    <div class="file-input-wrapper">
                        <input type="file" id="backupFileInput" class="file-input" accept=".html" onchange="handleBackupFileSelect(event)">
                    </div>
                    
                    <div class="btn-group" style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="restoreFromBackup()" id="restoreBtn" disabled>
                            <i class="fas fa-history"></i> Восстановить данные
                        </button>
                        <button class="btn btn-secondary" onclick="toggleImportSection()">
                            <i class="fas fa-times"></i> Отмена
                        </button>
                    </div>
                    
                    <div id="importStatus" class="status-message" style="margin-top: 15px;"></div>
                </div>
                
                <div class="btn-group" style="justify-content: center; margin-top: 30px;">
                    <button class="btn btn-primary" onclick="closeBackupModal()">
                        <i class="fas fa-times"></i> Закрыть
                    </button>
                </div>
            </div>
        </div>

        <!-- Модальное окно редактирования -->
        <div class="edit-modal" id="editModal">
            <div class="edit-panel">
                <div class="edit-header">
                    <h2 class="edit-title"><i class="fas fa-cogs"></i> Редактирование контента</h2>
                    <button class="close-edit" onclick="closeEditModal()">×</button>
                </div>
                
                <div class="edit-tabs">
                    <div class="edit-tab active" data-tab="themes">Темы</div>
                    <div class="edit-tab" data-tab="questions">Вопросы</div>
                    <div class="edit-tab" data-tab="locations">Локации</div>
                    <div class="edit-tab" data-tab="videos">Видео</div>
                    <div class="edit-tab" data-tab="history">История</div>
                </div>
                
                <div id="editStatus" class="status-message"></div>
                
                <!-- Вкладка Темы -->
                <div class="edit-section active" id="themesTab">
                    <div class="form-group">
                        <label>Выберите тему для редактирования:</label>
                        <select id="themeSelect" class="form-control">
                            <option value="">-- Новая тема --</option>
                        </select>
                    </div>
                    
                    <div class="edit-grid">
                        <div class="form-group">
                            <label for="editThemeName">Название темы *</label>
                            <input type="text" id="editThemeName" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="editThemeType">Тип *</label>
                            <select id="editThemeType" class="form-control">
                                <option value="quiz">Викторина</option>
                                <option value="photo">Фототур</option>
                                <option value="video">Видео тур</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="editThemeIcon">Иконка (FontAwesome)</label>
                        <input type="text" id="editThemeIcon" class="form-control" placeholder="fas fa-landmark">
                    </div>
                    
                    <div class="form-group">
                        <label for="editThemeDesc">Описание</label>
                        <textarea id="editThemeDesc" class="form-control" rows="3"></textarea>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="saveTheme()">
                            <i class="fas fa-save"></i> Сохранить тему
                        </button>
                        <button class="btn btn-danger" onclick="deleteTheme()" id="deleteThemeBtn" style="display: none;">
                            <i class="fas fa-trash"></i> Удалить тему
                        </button>
                        <button class="btn btn-secondary" onclick="addNewTheme()">
                            <i class="fas fa-plus"></i> Новая тема
                        </button>
                    </div>
                </div>
                
                <!-- Вкладка Вопросы -->
                <div class="edit-section" id="questionsTab">
                    <div class="edit-grid">
                        <div class="form-group">
                            <label for="questionTheme">Тема (Викторина) *</label>
                            <select id="questionTheme" class="form-control">
                                <option value="">-- Выберите тему --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="questionSelect">Вопрос:</label>
                            <select id="questionSelect" class="form-control">
                                <option value="">-- Новый вопрос --</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="editQuestionText">Текст вопроса *</label>
                        <textarea id="editQuestionText" class="form-control" rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="editQuestionImage">Ссылка на изображение</label>
                        <input type="text" id="editQuestionImage" class="form-control" placeholder="https://example.com/image.jpg">
                        <small style="color: #666; font-size: 0.9rem; margin-top: 5px; display: block;">
                            Примеры: https://placehold.co/600x400/0054A6/FFFFFF?text=Челны
                        </small>
                        <button type="button" class="btn test-image-btn btn-small" onclick="testImage()" style="margin-top: 10px;">
                            <i class="fas fa-eye"></i> Проверить изображение
                        </button>
                        <div class="image-preview" id="imagePreview">
                            <img src="" alt="Предпросмотр">
                        </div>
                    </div>
                    
                    <div class="form-group edit-question-info">
                        <label for="editQuestionInfo">Информация после ответа *</label>
                        <textarea id="editQuestionInfo" class="form-control" rows="3" placeholder="Эта информация покажется после ответа на вопрос"></textarea>
                        <small style="color: #666; font-size: 0.9rem; margin-top: 5px; display: block;">
                            Пример: Город был основан в 1626 году как поселение Челны на берегу реки Камы.
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label>Варианты ответов:</label>
                        <div id="optionsContainer"></div>
                        <button class="btn btn-secondary btn-small" onclick="addOption()">
                            <i class="fas fa-plus"></i> Добавить вариант
                        </button>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="saveQuestion()">
                            <i class="fas fa-save"></i> Сохранить вопрос
                        </button>
                        <button class="btn btn-danger" onclick="deleteQuestion()" id="deleteQuestionBtn" style="display: none;">
                            <i class="fas fa-trash"></i> Удалить вопрос
                        </button>
                        <button class="btn btn-secondary" onclick="addNewQuestion()">
                            <i class="fas fa-plus"></i> Новый вопрос
                        </button>
                    </div>
                </div>
                
                <!-- Вкладка Локации -->
                <div class="edit-section" id="locationsTab">
                    <div class="edit-grid">
                        <div class="form-group">
                            <label for="locationTheme">Тема (Фототур) *</label>
                            <select id="locationTheme" class="form-control">
                                <option value="">-- Выберите тему --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="locationSelect">Локация:</label>
                            <select id="locationSelect" class="form-control">
                                <option value="">-- Новая локация --</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="edit-grid">
                        <div class="form-group">
                            <label for="editLocationName">Название локации *</label>
                            <input type="text" id="editLocationName" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="editLocationImage">Ссылка на изображение *</label>
                            <input type="text" id="editLocationImage" class="form-control" placeholder="https://example.com/image.jpg">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="editLocationDesc">Описание *</label>
                        <textarea id="editLocationDesc" class="form-control" rows="4"></textarea>
                    </div>
                    
                    <div class="edit-grid">
                        <div class="form-group">
                            <label for="editLocationYear">Год основания/постройки</label>
                            <input type="text" id="editLocationYear" class="form-control">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="editLocationFunFact">Интересный факт</label>
                        <textarea id="editLocationFunFact" class="form-control" rows="2"></textarea>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="saveLocation()">
                            <i class="fas fa-save"></i> Сохранить локацию
                        </button>
                        <button class="btn btn-danger" onclick="deleteLocation()" id="deleteLocationBtn" style="display: none;">
                            <i class="fas fa-trash"></i> Удалить локацию
                        </button>
                        <button class="btn btn-secondary" onclick="addNewLocation()">
                            <i class="fas fa-plus"></i> Новая локация
                        </button>
                    </div>
                </div>
                
                <!-- Вкладка Видео -->
                <div class="edit-section" id="videosTab">
                    <div class="edit-grid">
                        <div class="form-group">
                            <label for="videoTheme">Тема (Видео тур) *</label>
                            <select id="videoTheme" class="form-control">
                                <option value="">-- Выберите тему --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="videoSelect">Видео:</label>
                            <select id="videoSelect" class="form-control">
                                <option value="">-- Новое видео --</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="edit-grid">
                        <div class="form-group">
                            <label for="editVideoTitle">Название видео *</label>
                            <input type="text" id="editVideoTitle" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="editVideoUrl">Ссылка на видео (YouTube или прямой URL) *</label>
                            <input type="text" id="editVideoUrl" class="form-control" placeholder="https://www.youtube.com/embed/... или https://example.com/video.mp4">
                            <small style="color: #666; font-size: 0.9rem; margin-top: 5px; display: block;">
                                Для YouTube: https://www.youtube.com/embed/КОД_ВИДЕО<br>
                                Для прямого видео: https://example.com/video.mp4
                            </small>
                            <button type="button" class="btn test-image-btn btn-small" onclick="testVideo()" style="margin-top: 10px;">
                                <i class="fas fa-eye"></i> Проверить видео
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="editVideoDescription">Описание видео *</label>
                        <textarea id="editVideoDescription" class="form-control" rows="4"></textarea>
                    </div>
                    
                    <div class="edit-grid">
                        <div class="form-group">
                            <label for="editVideoYear">Год съемки</label>
                            <input type="text" id="editVideoYear" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="editVideoDuration">Длительность (минуты)</label>
                            <input type="number" id="editVideoDuration" class="form-control" min="1" value="5">
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="saveVideo()">
                            <i class="fas fa-save"></i> Сохранить видео
                        </button>
                        <button class="btn btn-danger" onclick="deleteVideo()" id="deleteVideoBtn" style="display: none;">
                            <i class="fas fa-trash"></i> Удалить видео
                        </button>
                        <button class="btn btn-secondary" onclick="addNewVideo()">
                            <i class="fas fa-plus"></i> Новое видео
                        </button>
                    </div>
                </div>
                
                <!-- Вкладка История -->
                <div class="edit-section" id="historyTab">
                    <div class="form-group">
                        <label for="editHistoryTitle">Заголовок истории</label>
                        <input type="text" id="editHistoryTitle" class="form-control" value="История Набережных Челнов">
                    </div>
                    
                    <div class="form-group">
                        <label>Исторические факты:</label>
                        <div id="historyFactsContainer"></div>
                        <button class="btn btn-secondary" onclick="addHistoryFact()">
                            <i class="fas fa-plus"></i> Добавить факт
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label>Хронология:</label>
                        <div id="historyTimelineContainer"></div>
                        <button class="btn btn-secondary" onclick="addTimelineEvent()">
                            <i class="fas fa-plus"></i> Добавить событие
                        </button>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="saveHistory()">
                            <i class="fas fa-save"></i> Сохранить историю
                        </button>
                    </div>
                </div>
                
                <div class="btn-group" style="justify-content: center; margin-top: 30px;">
                    <button class="btn btn-primary" onclick="closeEditModal()">
                        <i class="fas fa-times"></i> Закрыть
                    </button>
                </div>
            </div>
        </div>

        <!-- Карта фототур-локаций -->
        <div class="tour-map-modal" id="tourMapModal">
            <div class="tour-map-container">
                <div class="map-header">
                    <h2 class="map-title"><i class="fas fa-map-marked-alt"></i> Карта фототура</h2>
                    <button class="close-map" onclick="closeTourMap()">×</button>
                </div>
                <div id="tourMapContent"></div>
                <div class="btn-group" style="justify-content: center; margin-top: 30px;">
                    <button class="btn btn-primary" onclick="closeTourMap()">
                        <i class="fas fa-times"></i> Закрыть карту
                    </button>
                </div>
            </div>
        </div>

        <!-- Полноэкранный режим видео -->
        <div class="fullscreen-video" id="fullscreenVideo">
            <button class="close-fullscreen" onclick="exitFullscreenVideo()">×</button>
            <div class="fullscreen-video-content" id="fullscreenVideoContent">
                <!-- Видео будет вставлено сюда -->
            </div>
        </div>

        <!-- Шапка -->
        <div class="header-container">
            <div class="coat-of-arms">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/cb/Coat_of_Arms_of_Naberezhnye_Chelny_%28Tatarstan%29.svg/990px-Coat_of_Arms_of_Naberezhnye_Chelny_%28Tatarstan%29.svg.png" 
                     alt="Герб Набережных Челнов"
                     onerror="this.src='https://placehold.co/180x220/0054A6/FFFFFF/png?text=Герб+Челнов'">
            </div>

            <div class="header-content">
                <div class="anniversary-text">Набережные Челны</div>
                <div class="city-name">Город на Каме</div>
                <div class="subtitle">Исследуйте город через викторины, фототуры и видео</div>
            </div>
        </div>

        <!-- История города -->
        <button class="history-btn" id="historyBtn">
            <i class="fas fa-book"></i> История города
        </button>

        <div class="history-panel" id="historyPanel">
            <h3><i class="fas fa-landmark"></i> <span id="historyTitle">История Набережных Челнов</span></h3>
            
            <div class="history-content" id="historyContent">
                <!-- Контент будет загружен динамически -->
            </div>
            
            <div class="history-timeline">
                <h4>Хронология развития</h4>
                <div id="timelineContent">
                    <!-- Контент будет загружен динамически -->
                </div>
            </div>
        </div>

        <!-- Темы викторин -->
        <div class="theme-groups" id="themeGroups">
            <!-- Контент будет загружен динамически -->
        </div>

        <!-- Секция для викторин -->
        <div id="quizSection" class="content-section">
            <button class="history-btn back-btn" onclick="showThemes()">
                <i class="fas fa-arrow-left"></i> Назад к темам
            </button>
            
            <div class="question-container" id="quizContainer">
                <!-- Контент викторины будет загружен динамически -->
            </div>
        </div>

        <!-- Секция для фототуров -->
        <div id="photoTourSection" class="content-section">
            <button class="history-btn back-btn" onclick="showThemes()">
                <i class="fas fa-arrow-left"></i> Назад к темам
            </button>
            
            <div class="photo-tour-container" id="photoTourContainer">
                <!-- Контент фототура будет загружен динамически -->
            </div>
        </div>

        <!-- Секция для видео туров -->
        <div id="videoTourSection" class="content-section">
            <button class="history-btn back-btn" onclick="showThemes()">
                <i class="fas fa-arrow-left"></i> Назад к темам
            </button>
            
            <div class="video-tour-container" id="videoTourContainer">
                <!-- Контент видео тура будет загружен динамически -->
            </div>
        </div>

        <footer>
            <div class="footer-title">Набережные Челны - Город трудовой доблести</div>
            <p>© 2026 Викторина, фототур и видео тур по городу</p>
            <p>Исследуйте красоту родного города через призму знаний и мультимедиа!</p>
            <div class="score-display">
                <i class="fas fa-star"></i> Ваш лучший результат в викторине: <span id="bestScore">0</span> баллов
            </div>
            <div class="score-display" style="margin-top: 10px;">
                <i class="fas fa-camera"></i> Исследовано локаций: <span id="locationsVisited">0</span>
            </div>
            <div class="score-display" style="margin-top: 10px;">
                <i class="fas fa-video"></i> Просмотрено видео: <span id="videosWatched">0</span>
            </div>
        </footer>
    </div>

    <script>
        // ============ ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ============
        let appData = {
            themes: [],
            quizzes: {},
            photoTours: {},
            videoTours: {},
            history: {
                title: "История Набережных Челнов",
                facts: [],
                timeline: []
            },
            currentTheme: null,
            currentQuestionIndex: 0,
            currentLocationIndex: 0,
            currentVideoIndex: 0,
            userAnswers: {},
            visitedLocations: {},
            watchedVideos: {},
            score: 0,
            bestScore: 0,
            isDarkTheme: false,
            isOptimizedMode: false,
            isAnswerChecked: false,
            currentAnswerCorrect: false
        };

        // ============ ФУНКЦИИ ДЛЯ ОБРАБОТКИ ИЗОБРАЖЕНИЙ ============
        function fixImageUrl(url) {
            if (!url || typeof url !== 'string' || url.trim() === '') {
                return generatePlaceholder();
            }
            
            let fixedUrl = url.trim();
            
            if (!fixedUrl.startsWith('http://') && !fixedUrl.startsWith('https://')) {
                fixedUrl = 'https://' + fixedUrl;
            }
            
            return fixedUrl;
        }

        function generatePlaceholder(options = {}) {
            const width = options.width || 600;
            const height = options.height || 400;
            const text = options.text || 'Набережные Челны';
            return `https://placehold.co/${width}x${height}/0054A6/FFFFFF/png?text=${encodeURIComponent(text)}`;
        }

        function testImage() {
            const imageUrl = document.getElementById('editQuestionImage')?.value || 
                            document.getElementById('editLocationImage')?.value || '';
            
            if (!imageUrl) {
                showStatus('Введите ссылку на изображение', 'error');
                return;
            }
            
            const fixedUrl = fixImageUrl(imageUrl);
            window.open(fixedUrl, '_blank');
        }

        function testVideo() {
            const videoUrl = document.getElementById('editVideoUrl')?.value || '';
            
            if (!videoUrl) {
                showStatus('Введите ссылку на видео', 'error');
                return;
            }
            
            const fixedUrl = fixVideoUrl(videoUrl);
            window.open(fixedUrl, '_blank');
        }

        function fixVideoUrl(url) {
            if (!url || typeof url !== 'string' || url.trim() === '') {
                return '';
            }
            
            let fixedUrl = url.trim();
            
            // Если это YouTube ссылка, преобразуем в embed
            if (fixedUrl.includes('youtube.com/watch?v=')) {
                const videoId = fixedUrl.split('v=')[1]?.split('&')[0];
                if (videoId) {
                    fixedUrl = `https://www.youtube.com/embed/${videoId}`;
                }
            } else if (fixedUrl.includes('youtu.be/')) {
                const videoId = fixedUrl.split('youtu.be/')[1]?.split('?')[0];
                if (videoId) {
                    fixedUrl = `https://www.youtube.com/embed/${videoId}`;
                }
            }
            
            if (!fixedUrl.startsWith('http://') && !fixedUrl.startsWith('https://')) {
                fixedUrl = 'https://' + fixedUrl;
            }
            
            return fixedUrl;
        }

        // ============ ФУНКЦИИ СОХРАНЕНИЯ И ВОССТАНОВЛЕНИЯ ДАННЫХ ============

        function openBackupModal() {
            document.getElementById('backupModal').classList.add('active');
            document.getElementById('importSection').classList.remove('active');
            document.getElementById('importStatus').style.display = 'none';
        }

        function closeBackupModal() {
            document.getElementById('backupModal').classList.remove('active');
        }

        function toggleImportSection() {
            const importSection = document.getElementById('importSection');
            importSection.classList.toggle('active');
        }

        function handleBackupFileSelect(event) {
            const file = event.target.files[0];
            const restoreBtn = document.getElementById('restoreBtn');
            
            if (file && file.name.endsWith('.html')) {
                restoreBtn.disabled = false;
                showImportStatus('Файл выбран: ' + file.name, 'success');
            } else {
                restoreBtn.disabled = true;
                showImportStatus('Выберите файл в формате HTML', 'error');
            }
        }

        function showImportStatus(message, type) {
            const statusEl = document.getElementById('importStatus');
            statusEl.textContent = message;
            statusEl.className = `status-message status-${type}`;
            statusEl.style.display = 'block';
        }

        function downloadBackup() {
            // Создаем копию данных приложения
            const backupData = {
                themes: appData.themes,
                quizzes: appData.quizzes,
                photoTours: appData.photoTours,
                videoTours: appData.videoTours,
                history: appData.history,
                visitedLocations: appData.visitedLocations,
                watchedVideos: appData.watchedVideos,
                bestScore: appData.bestScore,
                isDarkTheme: appData.isDarkTheme,
                isOptimizedMode: appData.isOptimizedMode
            };
            
            // Получаем текущий HTML
            const htmlContent = document.documentElement.outerHTML;
            
            // Находим начальную позицию данных в скрипте
            const scriptStart = htmlContent.indexOf('let appData = {');
            const scriptEnd = htmlContent.indexOf('// ============ ФУНКЦИИ СОХРАНЕНИЯ И ВОССТАНОВЛЕНИЯ ДАННЫХ ============');
            
            if (scriptStart !== -1 && scriptEnd !== -1) {
                // Создаем новую HTML-строку с обновленными данными
                const beforeData = htmlContent.substring(0, scriptStart);
                const afterData = htmlContent.substring(scriptEnd);
                
                // Форматируем данные для вставки
                const formattedData = JSON.stringify(backupData, null, 2);
                
                // Заменяем определение appData
                const newAppData = `let appData = ${formattedData};\n\n        // ============ ФУНКЦИИ ДЛЯ ОБРАБОТКИ ИЗОБРАЖЕНИЙ ============`;
                
                // Собираем финальный HTML
                const finalHtml = beforeData + newAppData + afterData;
                
                // Создаем blob и ссылку для скачивания
                const blob = new Blob([finalHtml], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                
                // Создаем временную ссылку для скачивания
                const a = document.createElement('a');
                a.href = url;
                a.download = `Набережные_Челны_Виртуальный_Тур_${new Date().toISOString().split('T')[0]}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                // Освобождаем память
                setTimeout(() => URL.revokeObjectURL(url), 100);
                
                showStatus('HTML-файл успешно сохранен!', 'success');
            } else {
                showStatus('Ошибка при сохранении файла', 'error');
            }
        }

        function restoreFromBackup() {
            const fileInput = document.getElementById('backupFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showImportStatus('Выберите файл для восстановления', 'error');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const fileContent = e.target.result;
                    
                    // Находим данные в файле
                    const dataMatch = fileContent.match(/let appData = (\{[\s\S]*?\});\s*\n/);
                    
                    if (dataMatch && dataMatch[1]) {
                        try {
                            // Парсим данные из файла
                            const parsedData = JSON.parse(dataMatch[1]);
                            
                            // Обновляем данные приложения
                            appData.themes = parsedData.themes || [];
                            appData.quizzes = parsedData.quizzes || {};
                            appData.photoTours = parsedData.photoTours || {};
                            appData.videoTours = parsedData.videoTours || {};
                            appData.history = parsedData.history || { title: "", facts: [], timeline: [] };
                            appData.visitedLocations = parsedData.visitedLocations || {};
                            appData.watchedVideos = parsedData.watchedVideos || {};
                            appData.bestScore = parsedData.bestScore || 0;
                            
                            // Сохраняем в localStorage
                            saveData();
                            
                            // Обновляем интерфейс
                            updateThemesUI();
                            updateHistoryUI();
                            updateScoreDisplay();
                            
                            // Обновляем тему, если нужно
                            if (parsedData.isDarkTheme !== undefined && parsedData.isDarkTheme !== appData.isDarkTheme) {
                                appData.isDarkTheme = parsedData.isDarkTheme;
                                localStorage.setItem('chelny_dark_theme', appData.isDarkTheme);
                                updateTheme();
                            }
                            
                            if (parsedData.isOptimizedMode !== undefined && parsedData.isOptimizedMode !== appData.isOptimizedMode) {
                                appData.isOptimizedMode = parsedData.isOptimizedMode;
                                localStorage.setItem('chelny_optimized_mode', appData.isOptimizedMode);
                                if (appData.isOptimizedMode) {
                                    document.body.classList.add('optimized-mode');
                                } else {
                                    document.body.classList.remove('optimized-mode');
                                }
                                updateOptimizeButton();
                            }
                            
                            showImportStatus('Данные успешно восстановлены!', 'success');
                            
                            // Закрываем модальное окно через 2 секунды
                            setTimeout(() => {
                                closeBackupModal();
                                showStatus('Данные восстановлены из файла', 'success');
                            }, 2000);
                            
                        } catch (parseError) {
                            console.error('Ошибка парсинга данных:', parseError);
                            showImportStatus('Ошибка: неверный формат данных в файле', 'error');
                        }
                    } else {
                        showImportStatus('Ошибка: файл не содержит данных приложения', 'error');
                    }
                } catch (error) {
                    console.error('Ошибка восстановления:', error);
                    showImportStatus('Ошибка при чтении файла', 'error');
                }
            };
            
            reader.onerror = function() {
                showImportStatus('Ошибка при чтении файла', 'error');
            };
            
            reader.readAsText(file);
        }

        // ============ ИНИЦИАЛИЗАЦИЯ ============
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            initApp();
            initEditPanel();
        });

        function loadData() {
            const savedData = localStorage.getItem('chelny_app_data');
            if (savedData) {
                try {
                    const parsed = JSON.parse(savedData);
                    appData = { ...appData, ...parsed };
                } catch (e) {
                    console.error('Ошибка загрузки данных:', e);
                    loadDefaultData();
                }
            } else {
                loadDefaultData();
            }
            
            appData.isDarkTheme = localStorage.getItem('chelny_dark_theme') === 'true';
            appData.isOptimizedMode = localStorage.getItem('chelny_optimized_mode') === 'true';
            appData.bestScore = parseInt(localStorage.getItem('chelny_best_score')) || 0;
            
            // Загрузка посещенных локаций
            const visited = localStorage.getItem('chelny_visited_locations');
            if (visited) {
                try {
                    appData.visitedLocations = JSON.parse(visited);
                } catch (e) {
                    appData.visitedLocations = {};
                }
            }
            
            // Загрузка просмотренных видео
            const watched = localStorage.getItem('chelny_watched_videos');
            if (watched) {
                try {
                    appData.watchedVideos = JSON.parse(watched);
                } catch (e) {
                    appData.watchedVideos = {};
                }
            }
            
            updateTheme();
            if (appData.isOptimizedMode) {
                document.body.classList.add('optimized-mode');
            }
            updateScoreDisplay();
        }

        function saveData() {
            try {
                localStorage.setItem('chelny_app_data', JSON.stringify({
                    themes: appData.themes,
                    quizzes: appData.quizzes,
                    photoTours: appData.photoTours,
                    videoTours: appData.videoTours,
                    history: appData.history
                }));
                localStorage.setItem('chelny_visited_locations', JSON.stringify(appData.visitedLocations));
                localStorage.setItem('chelny_watched_videos', JSON.stringify(appData.watchedVideos));
                return true;
            } catch (e) {
                showStatus('Ошибка сохранения: ' + e.message, 'error');
                return false;
            }
        }

        function loadDefaultData() {
            // Темы по умолчанию
            appData.themes = [
                {
                    id: 'history',
                    name: 'История города',
                    type: 'quiz',
                    icon: 'fas fa-landmark',
                    description: 'Интересные факты из истории Челнов'
                },
                {
                    id: 'architecture',
                    name: 'Архитектура',
                    type: 'quiz',
                    icon: 'fas fa-building',
                    description: 'Знаменитые здания и сооружения'
                },
                {
                    id: 'sights',
                    name: 'Достопримечательности',
                    type: 'photo',
                    icon: 'fas fa-camera',
                    description: 'Фототур по знаковым местам'
                },
                {
                    id: 'industry',
                    name: 'Промышленность',
                    type: 'photo',
                    icon: 'fas fa-industry',
                    description: 'КамАЗ и другие предприятия'
                },
                {
                    id: 'city_video',
                    name: 'Видео тур',
                    type: 'video',
                    icon: 'fas fa-video',
                    description: 'Видео экскурсии по городу'
                }
            ];
            
            // Викторины по умолчанию
            appData.quizzes = {
                history: {
                    type: 'quiz',
                    name: 'История города',
                    questions: [
                        {
                            question: 'В каком году был основан город Набережные Челны?',
                            image: generatePlaceholder({ text: 'Основание города' }),
                            info: 'Город был основан в 1626 году как поселение Челны на берегу реки Камы.',
                            options: [
                                { text: '1626 год', correct: true },
                                { text: '1703 год', correct: false },
                                { text: '1780 год', correct: false },
                                { text: '1856 год', correct: false }
                            ]
                        }
                    ]
                }
            };
            
            // Фототуры по умолчанию
            appData.photoTours = {
                sights: {
                    type: 'photo',
                    name: 'Достопримечательности',
                    locations: [
                        {
                            name: "Проспект Мира",
                            image: generatePlaceholder({ text: 'Проспект Мира' }),
                            description: "Главная улица города, протянувшаяся через весь Новый город. Здесь расположены административные здания, магазины и культурные учреждения.",
                            year: "1970-е годы",
                            funFact: "Проспект Мира - самая длинная улица в городе, её длина составляет более 12 километров."
                        }
                    ]
                }
            };
            
            // Видео туры по умолчанию
            appData.videoTours = {
                city_video: {
                    type: 'video',
                    name: 'Видео тур',
                    videos: [
                        {
                            title: "Набережные Челны с высоты птичьего полета",
                            url: "https://www.youtube.com/embed/0lTU5v7h7_w",
                            description: "Великолепные виды города с высоты птичьего полета. Узнайте, как выглядит Набережные Челны с воздуха.",
                            year: "2023",
                            duration: 5
                        }
                    ]
                }
            };
            
            // История по умолчанию
            appData.history = {
                title: "История Набережных Челнов",
                facts: [
                    {
                        title: "Основание города",
                        content: "Город был основан в 1626 году как поселение Чалнинский починок на реке Чалне."
                    }
                ],
                timeline: [
                    {
                        year: "1626 год",
                        event: "Основание поселения Чалнинский починок"
                    }
                ]
            };
        }

        function updateScoreDisplay() {
            document.getElementById('bestScore').textContent = appData.bestScore;
            
            // Подсчет посещенных локаций
            let totalVisited = 0;
            Object.values(appData.visitedLocations).forEach(locations => {
                totalVisited += locations.length;
            });
            document.getElementById('locationsVisited').textContent = totalVisited;
            
            // Подсчет просмотренных видео
            let totalWatched = 0;
            Object.values(appData.watchedVideos).forEach(videos => {
                totalWatched += videos.length;
            });
            document.getElementById('videosWatched').textContent = totalWatched;
        }

        function initApp() {
            // Кнопка темы
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            
            // Кнопка редактирования
            document.getElementById('editBtn').addEventListener('click', openEditModal);
            
            // Кнопка оптимизации
            document.getElementById('optimizeBtn').addEventListener('click', toggleOptimizedMode);
            updateOptimizeButton();
            
            // Кнопка истории
            document.getElementById('historyBtn').addEventListener('click', function() {
                const panel = document.getElementById('historyPanel');
                panel.classList.toggle('active');
                
                const icon = this.querySelector('i');
                if (panel.classList.contains('active')) {
                    icon.className = 'fas fa-times';
                    this.innerHTML = '<i class="fas fa-times"></i> Скрыть историю';
                } else {
                    icon.className = 'fas fa-book';
                    this.innerHTML = '<i class="fas fa-book"></i> История города';
                }
            });
            
            updateHistoryUI();
            updateThemesUI();
        }

        function toggleTheme() {
            appData.isDarkTheme = !appData.isDarkTheme;
            localStorage.setItem('chelny_dark_theme', appData.isDarkTheme);
            updateTheme();
        }

        function updateTheme() {
            const body = document.body;
            const btn = document.getElementById('themeToggle');
            
            if (appData.isDarkTheme) {
                body.classList.add('dark-theme');
                btn.innerHTML = '<i class="fas fa-sun"></i> Светлая тема';
            } else {
                body.classList.remove('dark-theme');
                btn.innerHTML = '<i class="fas fa-moon"></i> Тёмная тема';
            }
        }

        function toggleOptimizedMode() {
            appData.isOptimizedMode = !appData.isOptimizedMode;
            localStorage.setItem('chelny_optimized_mode', appData.isOptimizedMode);
            
            if (appData.isOptimizedMode) {
                document.body.classList.add('optimized-mode');
                showStatus('Режим экономии включен', 'success');
            } else {
                document.body.classList.remove('optimized-mode');
                showStatus('Обычный режим восстановлен', 'success');
            }
            
            updateOptimizeButton();
            updateThemesUI();
        }

        function updateOptimizeButton() {
            const btn = document.getElementById('optimizeBtn');
            if (appData.isOptimizedMode) {
                btn.innerHTML = '<i class="fas fa-bolt"></i> Обычный режим';
            } else {
                btn.innerHTML = '<i class="fas fa-tachometer-alt"></i> Режим экономии';
            }
        }

        // ============ ИНТЕРФЕЙС ИСТОРИИ ============
        function updateHistoryUI() {
            document.getElementById('historyTitle').textContent = appData.history.title;
            
            const factsContainer = document.getElementById('historyContent');
            factsContainer.innerHTML = '';
            
            appData.history.facts.forEach(fact => {
                const factElement = document.createElement('div');
                factElement.className = 'history-item';
                factElement.innerHTML = `<h4>${fact.title}</h4><p>${fact.content}</p>`;
                factsContainer.appendChild(factElement);
            });
            
            const timelineContainer = document.getElementById('timelineContent');
            timelineContainer.innerHTML = '';
            
            appData.history.timeline.forEach(event => {
                const eventElement = document.createElement('div');
                eventElement.className = 'timeline-item';
                eventElement.innerHTML = `
                    <span class="timeline-year">${event.year}:</span>
                    <span class="timeline-event">${event.event}</span>
                `;
                timelineContainer.appendChild(eventElement);
            });
        }

        // ============ ИНТЕРФЕЙС ТЕМ ============
        function updateThemesUI() {
            const container = document.getElementById('themeGroups');
            container.innerHTML = '';
            
            const quizThemes = appData.themes.filter(t => t.type === 'quiz');
            const photoThemes = appData.themes.filter(t => t.type === 'photo');
            const videoThemes = appData.themes.filter(t => t.type === 'video');
            
            if (quizThemes.length > 0) {
                const quizGroup = createThemeGroup('Пройдите викторину', 'fas fa-question-circle', quizThemes);
                container.appendChild(quizGroup);
            }
            
            if (photoThemes.length > 0) {
                const photoGroup = createThemeGroup('Отправьтесь в фототур', 'fas fa-camera', photoThemes);
                container.appendChild(photoGroup);
            }
            
            if (videoThemes.length > 0) {
                const videoGroup = createThemeGroup('Смотрите видео туры', 'fas fa-video', videoThemes);
                container.appendChild(videoGroup);
            }
            
            document.querySelectorAll('.theme-card').forEach(card => {
                card.addEventListener('click', function() {
                    const themeId = this.dataset.theme;
                    startTheme(themeId);
                });
            });
        }

        function createThemeGroup(title, icon, themes) {
            const group = document.createElement('div');
            group.className = 'theme-group';
            
            group.innerHTML = `
                <div class="group-header">
                    <div class="group-icon"><i class="${icon}"></i></div>
                    <div class="group-title">${title}</div>
                    <div class="group-subtitle">${themes.length} тем</div>
                </div>
                <div class="theme-grid">
                    ${themes.map(theme => {
                        let badge = '';
                        if (theme.type === 'photo' && appData.photoTours[theme.id]) {
                            const visitedCount = appData.visitedLocations[theme.id]?.length || 0;
                            const totalCount = appData.photoTours[theme.id].locations.length;
                            if (visitedCount > 0) {
                                badge = `<div class="theme-badge" style="position: absolute; top: 10px; right: 10px; background: var(--chelny-green); color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem;">${visitedCount}/${totalCount}</div>`;
                            }
                        } else if (theme.type === 'video' && appData.videoTours[theme.id]) {
                            const watchedCount = appData.watchedVideos[theme.id]?.length || 0;
                            const totalCount = appData.videoTours[theme.id].videos.length;
                            if (watchedCount > 0) {
                                badge = `<div class="theme-badge" style="position: absolute; top: 10px; right: 10px; background: #9C27B0; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem;">${watchedCount}/${totalCount}</div>`;
                            }
                        }
                        
                        return `
                            <div class="theme-card" data-theme="${theme.id}" style="position: relative;">
                                <div class="theme-icon ${theme.type === 'video' ? 'theme-icon-video' : ''}"><i class="${theme.icon}"></i></div>
                                <div class="theme-title">${theme.name}</div>
                                <div class="theme-desc">${theme.description}</div>
                                ${badge}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            return group;
        }

        // ============ ФОТОТУР ============
        function startPhotoTour(themeId) {
            if (!appData.photoTours[themeId] || !appData.photoTours[themeId].locations.length) {
                alert('В этом фототуре пока нет локаций. Добавьте локации через панель редактирования.');
                return;
            }
            
            appData.currentTheme = themeId;
            appData.currentLocationIndex = 0;
            
            document.getElementById('themeGroups').style.display = 'none';
            document.getElementById('historyPanel').classList.remove('active');
            document.getElementById('historyBtn').innerHTML = '<i class="fas fa-book"></i> История города';
            document.getElementById('photoTourSection').classList.add('active');
            
            loadPhotoTourLocation();
        }

        function loadPhotoTourLocation() {
            const tour = appData.photoTours[appData.currentTheme];
            const location = tour.locations[appData.currentLocationIndex];
            const totalLocations = tour.locations.length;
            
            const container = document.getElementById('photoTourContainer');
            container.innerHTML = `
                <div class="photo-tour-header">
                    <h2 class="tour-title">
                        <i class="fas fa-camera"></i>
                        ${tour.name}
                    </h2>
                    <div class="tour-progress">
                        Локация ${appData.currentLocationIndex + 1}/${totalLocations}
                    </div>
                </div>
                
                <div class="tour-content">
                    <div class="tour-image-container">
                        <img src="${fixImageUrl(location.image)}" alt="${location.name}" 
                             class="tour-image"
                             onerror="this.onerror=null; this.src='${generatePlaceholder({ text: location.name })}'">
                    </div>
                    
                    <div class="tour-info">
                        <h3 class="location-title">${location.name}</h3>
                        
                        <div class="location-description">
                            ${location.description}
                        </div>
                        
                        <div class="location-details">
                            ${location.year ? `
                                <div class="detail-item">
                                    <div class="detail-label">Год основания/постройки</div>
                                    <div class="detail-value">${location.year}</div>
                                </div>
                            ` : ''}
                            
                            ${location.funFact ? `
                                <div class="detail-item" style="grid-column: 1 / -1;">
                                    <div class="detail-label">Интересный факт</div>
                                    <div class="detail-value">${location.funFact}</div>
                                </div>
                            ` : ''}
                        </div>
                        
                        ${location.funFact ? `
                            <button class="toggle-fact-btn" onclick="toggleFact()">
                                <i class="fas fa-eye-slash"></i> Скрыть интересный факт
                            </button>
                        ` : ''}
                        
                        <div class="tour-thumbnails" id="tourThumbnails">
                            <!-- Миниатюры будут добавлены динамически -->
                        </div>
                        
                        <div class="tour-navigation">
                            <button class="tour-btn" onclick="prevLocation()" ${appData.currentLocationIndex === 0 ? 'disabled' : ''}>
                                <i class="fas fa-arrow-left"></i> Назад
                            </button>
                            
                            <button class="tour-btn tour-map-btn" onclick="showTourMap()">
                                <i class="fas fa-map-marked-alt"></i> Карта тура
                            </button>
                            
                            <button class="tour-btn submit-btn" onclick="nextLocation()">
                                ${appData.currentLocationIndex === totalLocations - 1 ? 'Завершить тур' : 'Далее'}
                                <i class="fas fa-${appData.currentLocationIndex === totalLocations - 1 ? 'flag-checkered' : 'arrow-right'}"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Добавляем миниатюры
            updateThumbnails();
            
            // Помечаем локацию как посещенную
            markLocationAsVisited();
        }

        function toggleFact() {
            const factItem = document.querySelector('.detail-item:last-child');
            const toggleBtn = document.querySelector('.toggle-fact-btn');
            
            if (factItem) {
                if (factItem.style.display === 'none') {
                    factItem.style.display = '';
                    toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Скрыть интересный факт';
                } else {
                    factItem.style.display = 'none';
                    toggleBtn.innerHTML = '<i class="fas fa-eye"></i> Показать интересный факт';
                }
            }
        }

        function updateThumbnails() {
            const tour = appData.photoTours[appData.currentTheme];
            const container = document.getElementById('tourThumbnails');
            if (!container) return;
            
            container.innerHTML = '';
            
            tour.locations.forEach((loc, index) => {
                const thumb = document.createElement('div');
                thumb.className = `tour-thumbnail ${index === appData.currentLocationIndex ? 'active' : ''}`;
                thumb.onclick = () => {
                    appData.currentLocationIndex = index;
                    loadPhotoTourLocation();
                };
                
                thumb.innerHTML = `<img src="${fixImageUrl(loc.image)}" alt="${loc.name}" 
                                   onerror="this.onerror=null; this.src='${generatePlaceholder({ width: 120, height: 80, text: loc.name })}'">`;
                container.appendChild(thumb);
            });
        }

        function markLocationAsVisited() {
            const themeId = appData.currentTheme;
            if (!appData.visitedLocations[themeId]) {
                appData.visitedLocations[themeId] = [];
            }
            
            if (!appData.visitedLocations[themeId].includes(appData.currentLocationIndex)) {
                appData.visitedLocations[themeId].push(appData.currentLocationIndex);
                saveData();
                updateScoreDisplay();
            }
        }

        function prevLocation() {
            if (appData.currentLocationIndex > 0) {
                appData.currentLocationIndex--;
                loadPhotoTourLocation();
            }
        }

        function nextLocation() {
            const tour = appData.photoTours[appData.currentTheme];
            
            if (appData.currentLocationIndex < tour.locations.length - 1) {
                appData.currentLocationIndex++;
                loadPhotoTourLocation();
            } else {
                showTourComplete();
            }
        }

        function showTourComplete() {
            const tour = appData.photoTours[appData.currentTheme];
            const visitedCount = appData.visitedLocations[appData.currentTheme]?.length || 0;
            const totalCount = tour.locations.length;
            
            const container = document.getElementById('photoTourContainer');
            container.innerHTML = `
                <div style="text-align: center; padding: 50px;">
                    <h2 style="font-size: 3rem; color: var(--chelny-green); margin-bottom: 20px;">
                        <i class="fas fa-camera-retro"></i>
                    </h2>
                    <h3 style="font-size: 2rem; color: var(--chelny-green); margin-bottom: 30px;">
                        Фототур завершён!
                    </h3>
                    <div style="font-size: 4rem; font-weight: bold; color: var(--chelny-blue); margin: 30px 0;">
                        ${visitedCount}/${totalCount}
                    </div>
                    <p style="font-size: 1.2rem; margin-bottom: 40px;">
                        Вы исследовали ${visitedCount} из ${totalCount} локаций в фототуре "${tour.name}"
                    </p>
                    <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                        <button class="tour-btn" onclick="showThemes()">
                            <i class="fas fa-home"></i> На главную
                        </button>
                        <button class="tour-btn tour-map-btn" onclick="showTourMap()">
                            <i class="fas fa-map"></i> Карта тура
                        </button>
                        <button class="tour-btn submit-btn" onclick="restartPhotoTour()">
                            <i class="fas fa-redo"></i> Пройти еще раз
                        </button>
                    </div>
                </div>
            `;
        }

        function restartPhotoTour() {
            appData.currentLocationIndex = 0;
            loadPhotoTourLocation();
        }

        function showTourMap() {
            const tour = appData.photoTours[appData.currentTheme];
            const visited = appData.visitedLocations[appData.currentTheme] || [];
            
            const mapContent = document.getElementById('tourMapContent');
            mapContent.innerHTML = `
                <h3 style="margin-bottom: 20px; color: var(--text-color);">Локации фототура "${tour.name}"</h3>
                <div class="map-grid">
                    ${tour.locations.map((loc, index) => {
                        const isVisited = visited.includes(index);
                        const isCurrent = index === appData.currentLocationIndex;
                        
                        return `
                            <div class="map-location ${isCurrent ? 'active' : ''} ${isVisited ? 'map-location-visited' : ''}"
                                 onclick="goToLocation(${index})">
                                <div class="map-location-number">${index + 1}</div>
                                <div class="map-location-title">${loc.name}</div>
                                ${loc.year ? `<div class="map-location-desc">${loc.year}</div>` : ''}
                                ${isVisited ? '<div style="margin-top: 10px; color: var(--chelny-green);"><i class="fas fa-check-circle"></i> Посещено</div>' : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            document.getElementById('tourMapModal').classList.add('active');
        }

        function goToLocation(index) {
            appData.currentLocationIndex = index;
            closeTourMap();
            loadPhotoTourLocation();
        }

        function closeTourMap() {
            document.getElementById('tourMapModal').classList.remove('active');
        }

        // ============ ВИДЕО ТУР ============
        function startVideoTour(themeId) {
            if (!appData.videoTours[themeId] || !appData.videoTours[themeId].videos.length) {
                alert('В этом видео туре пока нет видео. Добавьте видео через панель редактирования.');
                return;
            }
            
            appData.currentTheme = themeId;
            appData.currentVideoIndex = 0;
            
            document.getElementById('themeGroups').style.display = 'none';
            document.getElementById('historyPanel').classList.remove('active');
            document.getElementById('historyBtn').innerHTML = '<i class="fas fa-book"></i> История города';
            document.getElementById('videoTourSection').classList.add('active');
            
            loadVideoTourVideo();
        }

        function loadVideoTourVideo() {
            const tour = appData.videoTours[appData.currentTheme];
            const video = tour.videos[appData.currentVideoIndex];
            const totalVideos = tour.videos.length;
            
            const container = document.getElementById('videoTourContainer');
            container.innerHTML = `
                <div class="video-tour-header">
                    <h2 class="tour-title">
                        <i class="fas fa-video"></i>
                        ${tour.name}
                    </h2>
                    <div class="tour-progress">
                        Видео ${appData.currentVideoIndex + 1}/${totalVideos}
                    </div>
                </div>
                
                <div class="tour-content">
                    <div class="video-container">
                        <div class="video-wrapper" id="videoWrapper">
                            ${getVideoEmbedCode(video.url)}
                        </div>
                        <div class="video-controls">
                            <div class="video-info">
                                <h3 class="location-title">${video.title}</h3>
                                ${video.year ? `<div><strong>Год съемки:</strong> ${video.year}</div>` : ''}
                                ${video.duration ? `<div><strong>Длительность:</strong> ${video.duration} минут</div>` : ''}
                            </div>
                            <button class="fullscreen-btn" onclick="openFullscreenVideo('${video.url}')">
                                <i class="fas fa-expand"></i> На весь экран
                            </button>
                        </div>
                    </div>
                    
                    <div class="tour-info">
                        <div class="location-description">
                            ${video.description}
                        </div>
                        
                        <div class="tour-thumbnails" id="videoThumbnails">
                            <!-- Миниатюры видео будут добавлены динамически -->
                        </div>
                        
                        <div class="tour-navigation">
                            <button class="tour-btn" onclick="prevVideo()" ${appData.currentVideoIndex === 0 ? 'disabled' : ''}>
                                <i class="fas fa-arrow-left"></i> Назад
                            </button>
                            
                            <button class="tour-btn submit-btn" onclick="nextVideo()">
                                ${appData.currentVideoIndex === totalVideos - 1 ? 'Завершить тур' : 'Далее'}
                                <i class="fas fa-${appData.currentVideoIndex === totalVideos - 1 ? 'flag-checkered' : 'arrow-right'}"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Добавляем миниатюры видео
            updateVideoThumbnails();
            
            // Помечаем видео как просмотренное
            markVideoAsWatched();
        }

        function getVideoEmbedCode(url) {
            if (!url) return '<div style="padding: 100px; text-align: center; color: #666;">Видео не загружено</div>';
            
            const fixedUrl = fixVideoUrl(url);
            
            if (fixedUrl.includes('youtube.com/embed/') || fixedUrl.includes('youtu.be/')) {
                return `<iframe src="${fixedUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
            } else {
                return `<video controls style="width: 100%; height: 100%;">
                    <source src="${fixedUrl}" type="video/mp4">
                    Ваш браузер не поддерживает видео тег.
                </video>`;
            }
        }

        function updateVideoThumbnails() {
            const tour = appData.videoTours[appData.currentTheme];
            const container = document.getElementById('videoThumbnails');
            if (!container) return;
            
            container.innerHTML = '';
            
            tour.videos.forEach((vid, index) => {
                const thumb = document.createElement('div');
                thumb.className = `tour-thumbnail ${index === appData.currentVideoIndex ? 'active' : ''}`;
                thumb.onclick = () => {
                    appData.currentVideoIndex = index;
                    loadVideoTourVideo();
                };
                
                thumb.innerHTML = `<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: var(--chelny-blue); color: white; border-radius: 10px;">
                    <i class="fas fa-play" style="font-size: 2rem;"></i>
                </div>`;
                container.appendChild(thumb);
            });
        }

        function markVideoAsWatched() {
            const themeId = appData.currentTheme;
            if (!appData.watchedVideos[themeId]) {
                appData.watchedVideos[themeId] = [];
            }
            
            if (!appData.watchedVideos[themeId].includes(appData.currentVideoIndex)) {
                appData.watchedVideos[themeId].push(appData.currentVideoIndex);
                saveData();
                updateScoreDisplay();
            }
        }

        function prevVideo() {
            if (appData.currentVideoIndex > 0) {
                appData.currentVideoIndex--;
                loadVideoTourVideo();
            }
        }

        function nextVideo() {
            const tour = appData.videoTours[appData.currentTheme];
            
            if (appData.currentVideoIndex < tour.videos.length - 1) {
                appData.currentVideoIndex++;
                loadVideoTourVideo();
            } else {
                showVideoTourComplete();
            }
        }

        function showVideoTourComplete() {
            const tour = appData.videoTours[appData.currentTheme];
            const watchedCount = appData.watchedVideos[appData.currentTheme]?.length || 0;
            const totalCount = tour.videos.length;
            
            const container = document.getElementById('videoTourContainer');
            container.innerHTML = `
                <div style="text-align: center; padding: 50px;">
                    <h2 style="font-size: 3rem; color: #9C27B0; margin-bottom: 20px;">
                        <i class="fas fa-film"></i>
                    </h2>
                    <h3 style="font-size: 2rem; color: #9C27B0; margin-bottom: 30px;">
                        Видео тур завершён!
                    </h3>
                    <div style="font-size: 4rem; font-weight: bold; color: #9C27B0; margin: 30px 0;">
                        ${watchedCount}/${totalCount}
                    </div>
                    <p style="font-size: 1.2rem; margin-bottom: 40px;">
                        Вы посмотрели ${watchedCount} из ${totalCount} видео в туре "${tour.name}"
                    </p>
                    <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                        <button class="tour-btn" onclick="showThemes()">
                            <i class="fas fa-home"></i> На главную
                        </button>
                        <button class="tour-btn submit-btn" onclick="restartVideoTour()" style="background: linear-gradient(135deg, #9C27B0, #7B1FA2);">
                            <i class="fas fa-redo"></i> Смотреть еще раз
                        </button>
                    </div>
                </div>
            `;
        }

        function restartVideoTour() {
            appData.currentVideoIndex = 0;
            loadVideoTourVideo();
        }

        // ============ ПОЛНОЭКРАННЫЙ РЕЖИМ ВИДЕО ============
        function openFullscreenVideo(videoUrl) {
            const fullscreenContainer = document.getElementById('fullscreenVideo');
            const videoContent = document.getElementById('fullscreenVideoContent');
            
            videoContent.innerHTML = `
                <div class="video-wrapper">
                    ${getVideoEmbedCode(videoUrl)}
                </div>
            `;
            
            fullscreenContainer.classList.add('active');
            
            // Запускаем видео, если это HTML5 видео
            const videoElement = videoContent.querySelector('video');
            if (videoElement) {
                videoElement.play();
            }
        }

        function exitFullscreenVideo() {
            const fullscreenContainer = document.getElementById('fullscreenVideo');
            fullscreenContainer.classList.remove('active');
            
            // Останавливаем видео
            const videoContent = document.getElementById('fullscreenVideoContent');
            const videoElement = videoContent.querySelector('video');
            if (videoElement) {
                videoElement.pause();
            }
            
            videoContent.innerHTML = '';
        }

        // ============ ВИКТОРИНА ============
        function startTheme(themeId) {
            const theme = appData.themes.find(t => t.id === themeId);
            
            if (theme.type === 'quiz') {
                startQuiz(themeId);
            } else if (theme.type === 'photo') {
                startPhotoTour(themeId);
            } else if (theme.type === 'video') {
                startVideoTour(themeId);
            }
        }

        function startQuiz(themeId) {
            if (!appData.quizzes[themeId]) {
                alert('Эта тема пока не содержит вопросов. Добавьте вопросы через панель редактирования.');
                return;
            }
            
            appData.currentTheme = themeId;
            appData.currentQuestionIndex = 0;
            appData.userAnswers[themeId] = [];
            appData.score = 0;
            appData.isAnswerChecked = false;
            appData.currentAnswerCorrect = false;
            
            document.getElementById('themeGroups').style.display = 'none';
            document.getElementById('historyPanel').classList.remove('active');
            document.getElementById('historyBtn').innerHTML = '<i class="fas fa-book"></i> История города';
            document.getElementById('quizSection').classList.add('active');
            
            loadQuestion();
        }

        function loadQuestion() {
            const theme = appData.quizzes[appData.currentTheme];
            const question = theme.questions[appData.currentQuestionIndex];
            
            // Сбрасываем флаги для нового вопроса
            appData.isAnswerChecked = false;
            appData.currentAnswerCorrect = false;
            
            const container = document.getElementById('quizContainer');
            container.innerHTML = `
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="${getThemeIcon(appData.currentTheme)}"></i>
                        ${theme.name}
                    </h2>
                    <div class="question-counter">Вопрос ${appData.currentQuestionIndex + 1}/${theme.questions.length}</div>
                </div>
                
                <div class="question-content">
                    <div class="question-image">
                        <img src="${fixImageUrl(question.image)}" alt="${question.question}" 
                             onerror="this.onerror=null; this.src='${generatePlaceholder({ text: 'Челны' })}'">
                    </div>
                    
                    <div class="question-text-container">
                        <div class="question-text">${question.question}</div>
                        
                        <div class="options-grid" id="optionsGrid">
                            ${question.options.map((option, index) => `
                                <div class="option" data-index="${index}" onclick="selectOption(${index})">
                                    <div class="option-letter">${String.fromCharCode(65 + index)}</div>
                                    <div>${option.text}</div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="answer-feedback" id="answerFeedback">
                            <!-- Здесь будет отображаться информация о правильности ответа -->
                        </div>
                        
                        <div class="navigation">
                            <button class="nav-btn" onclick="prevQuestion()" ${appData.currentQuestionIndex === 0 ? 'disabled' : ''}>
                                <i class="fas fa-arrow-left"></i> Назад
                            </button>
                            
                            <button class="nav-btn check-answer-btn" onclick="checkAnswer()" id="checkAnswerBtn" ${!appData.userAnswers[appData.currentTheme] || appData.userAnswers[appData.currentTheme][appData.currentQuestionIndex] === undefined ? 'disabled' : ''}>
                                <i class="fas fa-check-circle"></i> Проверить ответ
                            </button>
                            
                            <button class="nav-btn continue-btn" onclick="nextQuestion()" id="continueBtn" style="display: none;">
                                <i class="fas fa-arrow-right"></i> Следующий вопрос
                            </button>
                            
                            ${appData.currentQuestionIndex === theme.questions.length - 1 ? 
                                `<button class="nav-btn submit-btn" onclick="finishQuiz()" id="finishBtn" style="display: none;">
                                    <i class="fas fa-flag-checkered"></i> Завершить викторину
                                </button>` : ''
                            }
                        </div>
                    </div>
                </div>
            `;
            
            // Восстанавливаем выбранный ответ, если он есть
            if (appData.userAnswers[appData.currentTheme] && appData.userAnswers[appData.currentTheme][appData.currentQuestionIndex] !== undefined) {
                selectOption(appData.userAnswers[appData.currentTheme][appData.currentQuestionIndex]);
            }
            
            // Если ответ уже был проверен (при возврате к вопросу), показываем результат
            if (appData.isAnswerChecked) {
                showAnswerResult();
            }
        }

        function selectOption(index) {
            const options = document.querySelectorAll('.option');
            options.forEach(opt => {
                opt.classList.remove('selected');
                opt.classList.remove('correct');
                opt.classList.remove('incorrect');
            });
            options[index].classList.add('selected');
            
            if (!appData.userAnswers[appData.currentTheme]) {
                appData.userAnswers[appData.currentTheme] = [];
            }
            appData.userAnswers[appData.currentTheme][appData.currentQuestionIndex] = index;
            
            // Активируем кнопку "Проверить ответ"
            document.getElementById('checkAnswerBtn').disabled = false;
            
            // Скрываем кнопку "Следующий вопрос" пока не проверен ответ
            document.getElementById('continueBtn').style.display = 'none';
            const finishBtn = document.getElementById('finishBtn');
            if (finishBtn) finishBtn.style.display = 'none';
            
            // Скрываем feedback
            const feedback = document.getElementById('answerFeedback');
            if (feedback) {
                feedback.classList.remove('show');
                feedback.classList.remove('correct', 'incorrect');
            }
        }

        function checkAnswer() {
            const theme = appData.quizzes[appData.currentTheme];
            const question = theme.questions[appData.currentQuestionIndex];
            
            // Проверяем, выбран ли ответ
            if (appData.userAnswers[appData.currentTheme][appData.currentQuestionIndex] === undefined) {
                alert('Пожалуйста, выберите ответ!');
                return;
            }
            
            // Проверяем ответ
            const userAnswer = appData.userAnswers[appData.currentTheme][appData.currentQuestionIndex];
            appData.currentAnswerCorrect = question.options[userAnswer].correct;
            
            // Устанавливаем флаг, что ответ проверен
            appData.isAnswerChecked = true;
            
            // Показываем результат
            showAnswerResult();
        }

        function showAnswerResult() {
            const theme = appData.quizzes[appData.currentTheme];
            const question = theme.questions[appData.currentQuestionIndex];
            const userAnswer = appData.userAnswers[appData.currentTheme][appData.currentQuestionIndex];
            
            // Подсвечиваем правильные/неправильные ответы
            const options = document.querySelectorAll('.option');
            options.forEach((opt, index) => {
                if (question.options[index].correct) {
                    opt.classList.add('correct');
                }
                if (index === userAnswer && !appData.currentAnswerCorrect) {
                    opt.classList.add('incorrect');
                }
            });
            
            // Показываем feedback с информацией из question.info
            const feedback = document.getElementById('answerFeedback');
            if (feedback) {
                if (appData.currentAnswerCorrect) {
                    feedback.className = 'answer-feedback correct show';
                    feedback.innerHTML = `
                        <div style="display: flex; align-items: center;">
                            <i class="fas fa-check-circle feedback-icon"></i>
                            <div>
                                <strong>Правильно!</strong>
                                <div>${question.info || 'Вы выбрали правильный ответ!'}</div>
                            </div>
                        </div>
                    `;
                } else {
                    feedback.className = 'answer-feedback incorrect show';
                    feedback.innerHTML = `
                        <div style="display: flex; align-items: center;">
                            <i class="fas fa-times-circle feedback-icon"></i>
                            <div>
                                <strong>Неправильно!</strong>
                                <div>${question.info || 'Попробуйте еще раз!'}</div>
                            </div>
                        </div>
                    `;
                }
            }
            
            // Меняем кнопки
            document.getElementById('checkAnswerBtn').style.display = 'none';
            
            const themeQuiz = appData.quizzes[appData.currentTheme];
            const isLastQuestion = appData.currentQuestionIndex === themeQuiz.questions.length - 1;
            
            if (isLastQuestion) {
                document.getElementById('finishBtn').style.display = 'flex';
            } else {
                document.getElementById('continueBtn').style.display = 'flex';
            }
        }

        function nextQuestion() {
            const theme = appData.quizzes[appData.currentTheme];
            
            // Добавляем очки за правильный ответ
            if (appData.currentAnswerCorrect) {
                appData.score += 20;
            }
            
            // Переходим к следующему вопросу
            if (appData.currentQuestionIndex < theme.questions.length - 1) {
                appData.currentQuestionIndex++;
                loadQuestion();
            }
        }

        function finishQuiz() {
            const theme = appData.quizzes[appData.currentTheme];
            
            // Добавляем очки за правильный ответ на последнем вопросе
            if (appData.currentAnswerCorrect) {
                appData.score += 20;
            }
            
            showResults();
        }

        function prevQuestion() {
            if (appData.currentQuestionIndex > 0) {
                appData.currentQuestionIndex--;
                loadQuestion();
            }
        }

        function showResults() {
            const theme = appData.quizzes[appData.currentTheme];
            const maxScore = theme.questions.length * 20;
            
            // Обновляем лучший результат
            if (appData.score > appData.bestScore) {
                appData.bestScore = appData.score;
                localStorage.setItem('chelny_best_score', appData.bestScore);
                updateScoreDisplay();
            }
            
            const container = document.getElementById('quizContainer');
            container.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <h2 style="font-size: 2.5rem; margin-bottom: 20px; color: var(--chelny-green);">Поздравляем!</h2>
                    <div style="font-size: 4rem; font-weight: bold; color: var(--chelny-green); margin: 30px 0;">
                        ${appData.score}/${maxScore}
                    </div>
                    <p style="font-size: 1.2rem; margin-bottom: 30px;">
                        Правильных ответов: ${appData.score / 20} из ${theme.questions.length}
                    </p>
                    <button class="nav-btn" onclick="showThemes()" style="margin: 20px;">
                        <i class="fas fa-redo"></i> Вернуться к темам
                    </button>
                    <button class="nav-btn submit-btn" onclick="restartQuiz()" style="margin: 20px;">
                        <i class="fas fa-play"></i> Пройти еще раз
                    </button>
                </div>
            `;
        }

        function restartQuiz() {
            appData.currentQuestionIndex = 0;
            appData.userAnswers[appData.currentTheme] = [];
            appData.score = 0;
            appData.isAnswerChecked = false;
            appData.currentAnswerCorrect = false;
            loadQuestion();
        }

        function showThemes() {
            document.getElementById('quizSection').classList.remove('active');
            document.getElementById('photoTourSection').classList.remove('active');
            document.getElementById('videoTourSection').classList.remove('active');
            document.getElementById('themeGroups').style.display = 'flex';
            appData.currentTheme = null;
            updateThemesUI();
        }

        function getThemeIcon(themeId) {
            const theme = appData.themes.find(t => t.id === themeId);
            return theme ? theme.icon : 'fas fa-question';
        }

        // ============ ПАНЕЛЬ РЕДАКТИРОВАНИЯ ============
        function initEditPanel() {
            document.querySelectorAll('.edit-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.dataset.tab;
                    switchEditTab(tabId);
                });
            });
            
            updateThemeSelectors();
        }

        function openEditModal() {
            document.getElementById('editModal').classList.add('active');
            updateThemeSelectors();
            loadHistoryForm();
            switchEditTab('themes');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            document.getElementById('editStatus').style.display = 'none';
        }

        function switchEditTab(tabId) {
            document.querySelectorAll('.edit-section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.querySelectorAll('.edit-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabId + 'Tab').classList.add('active');
            document.querySelector(`.edit-tab[data-tab="${tabId}"]`).classList.add('active');
            
            if (tabId === 'questions') {
                loadQuestionsForTheme();
            } else if (tabId === 'locations') {
                loadLocationsForTheme();
            } else if (tabId === 'videos') {
                loadVideosForTheme();
            }
        }

        function showStatus(message, type) {
            const statusEl = document.getElementById('editStatus');
            statusEl.textContent = message;
            statusEl.className = `status-message status-${type}`;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 3000);
        }

        // ============ РЕДАКТИРОВАНИЕ ТЕМ ============
        function updateThemeSelectors() {
            const selectors = ['themeSelect', 'questionTheme', 'locationTheme', 'videoTheme'];
            
            selectors.forEach(selectorId => {
                const select = document.getElementById(selectorId);
                select.innerHTML = '<option value="">-- Выберите тему --</option>';
                
                appData.themes.forEach(theme => {
                    const option = document.createElement('option');
                    option.value = theme.id;
                    let typeText = '';
                    if (theme.type === 'quiz') typeText = 'Викторина';
                    else if (theme.type === 'photo') typeText = 'Фототур';
                    else if (theme.type === 'video') typeText = 'Видео тур';
                    option.textContent = `${theme.name} (${typeText})`;
                    select.appendChild(option);
                });
            });
            
            document.getElementById('themeSelect').addEventListener('change', function() {
                if (this.value) {
                    loadThemeForm(this.value);
                } else {
                    clearThemeForm();
                }
            });
            
            document.getElementById('questionTheme').addEventListener('change', loadQuestionsForTheme);
            document.getElementById('locationTheme').addEventListener('change', loadLocationsForTheme);
            document.getElementById('videoTheme').addEventListener('change', loadVideosForTheme);
        }

        function loadThemeForm(themeId) {
            const theme = appData.themes.find(t => t.id === themeId);
            if (!theme) return;
            
            document.getElementById('editThemeName').value = theme.name;
            document.getElementById('editThemeType').value = theme.type;
            document.getElementById('editThemeIcon').value = theme.icon;
            document.getElementById('editThemeDesc').value = theme.description || '';
            
            document.getElementById('deleteThemeBtn').style.display = 'block';
        }

        function clearThemeForm() {
            document.getElementById('editThemeName').value = '';
            document.getElementById('editThemeType').value = 'quiz';
            document.getElementById('editThemeIcon').value = 'fas fa-folder';
            document.getElementById('editThemeDesc').value = '';
            
            document.getElementById('deleteThemeBtn').style.display = 'none';
        }

        function saveTheme() {
            const themeId = document.getElementById('themeSelect').value;
            const name = document.getElementById('editThemeName').value.trim();
            const type = document.getElementById('editThemeType').value;
            const icon = document.getElementById('editThemeIcon').value.trim();
            const description = document.getElementById('editThemeDesc').value.trim();
            
            if (!name) {
                showStatus('Введите название темы', 'error');
                return;
            }
            
            let newId = themeId;
            
            if (!themeId) {
                newId = name.toLowerCase().replace(/[^a-z0-9]/g, '_');
                appData.themes.push({
                    id: newId,
                    name,
                    type,
                    icon: icon || 'fas fa-folder',
                    description
                });
                
                // Инициализируем пустые данные для новой темы
                if (type === 'quiz') {
                    appData.quizzes[newId] = {
                        type: 'quiz',
                        name: name,
                        questions: []
                    };
                } else if (type === 'photo') {
                    appData.photoTours[newId] = {
                        type: 'photo',
                        name: name,
                        locations: []
                    };
                } else if (type === 'video') {
                    appData.videoTours[newId] = {
                        type: 'video',
                        name: name,
                        videos: []
                    };
                }
                
                showStatus('Тема создана!', 'success');
            } else {
                const themeIndex = appData.themes.findIndex(t => t.id === themeId);
                if (themeIndex !== -1) {
                    appData.themes[themeIndex] = {
                        ...appData.themes[themeIndex],
                        name,
                        type,
                        icon: icon || 'fas fa-folder',
                        description
                    };
                }
                
                // Обновляем имя в соответствующих данных
                if (type === 'quiz' && appData.quizzes[themeId]) {
                    appData.quizzes[themeId].name = name;
                } else if (type === 'photo' && appData.photoTours[themeId]) {
                    appData.photoTours[themeId].name = name;
                } else if (type === 'video' && appData.videoTours[themeId]) {
                    appData.videoTours[themeId].name = name;
                }
                
                showStatus('Тема обновлена!', 'success');
            }
            
            if (saveData()) {
                updateThemeSelectors();
                updateThemesUI();
                document.getElementById('themeSelect').value = newId;
                loadThemeForm(newId);
            }
        }

        function addNewTheme() {
            document.getElementById('themeSelect').value = '';
            clearThemeForm();
        }

        function deleteTheme() {
            const themeId = document.getElementById('themeSelect').value;
            if (!themeId) return;
            
            if (!confirm('Удалить эту тему? Все вопросы, локации и видео в ней будут удалены.')) {
                return;
            }
            
            appData.themes = appData.themes.filter(t => t.id !== themeId);
            delete appData.quizzes[themeId];
            delete appData.photoTours[themeId];
            delete appData.videoTours[themeId];
            delete appData.visitedLocations[themeId];
            delete appData.watchedVideos[themeId];
            
            if (saveData()) {
                updateThemeSelectors();
                updateThemesUI();
                clearThemeForm();
                showStatus('Тема удалена', 'success');
            }
        }

        // ============ РЕДАКТИРОВАНИЕ ВОПРОСОВ ============
        function loadQuestionsForTheme() {
            const themeId = document.getElementById('questionTheme').value;
            const select = document.getElementById('questionSelect');
            select.innerHTML = '<option value="">-- Новый вопрос --</option>';
            
            if (!themeId || !appData.quizzes[themeId]) return;
            
            const questions = appData.quizzes[themeId].questions || [];
            questions.forEach((q, index) => {
                const option = document.createElement('option');
                option.value = index;
                const shortText = q.question.length > 50 ? q.question.substring(0, 50) + '...' : q.question;
                option.textContent = `Вопрос ${index + 1}: ${shortText}`;
                select.appendChild(option);
            });
            
            select.addEventListener('change', function() {
                if (this.value !== '') {
                    loadQuestionForm(themeId, parseInt(this.value));
                } else {
                    clearQuestionForm();
                }
            });
        }

        function loadQuestionForm(themeId, questionIndex) {
            if (!appData.quizzes[themeId] || !appData.quizzes[themeId].questions[questionIndex]) {
                showStatus('Вопрос не найден', 'error');
                return;
            }
            
            const question = appData.quizzes[themeId].questions[questionIndex];
            
            document.getElementById('editQuestionText').value = question.question;
            document.getElementById('editQuestionImage').value = question.image || '';
            document.getElementById('editQuestionInfo').value = question.info || '';
            
            const container = document.getElementById('optionsContainer');
            container.innerHTML = '';
            
            if (question.options && question.options.length > 0) {
                question.options.forEach((option, index) => {
                    addOptionToForm(option.text, option.correct, index);
                });
            } else {
                addOptionToForm('', true, 0);
                addOptionToForm('', false, 1);
            }
            
            document.getElementById('deleteQuestionBtn').style.display = 'block';
        }

        function clearQuestionForm() {
            document.getElementById('questionSelect').value = '';
            document.getElementById('editQuestionText').value = '';
            document.getElementById('editQuestionImage').value = '';
            document.getElementById('editQuestionInfo').value = '';
            
            const container = document.getElementById('optionsContainer');
            container.innerHTML = '';
            
            addOptionToForm('', true, 0);
            addOptionToForm('', false, 1);
            
            document.getElementById('deleteQuestionBtn').style.display = 'none';
            document.getElementById('imagePreview').classList.remove('active');
        }

        function addOption() {
            const container = document.getElementById('optionsContainer');
            const index = container.children.length;
            addOptionToForm('', false, index);
        }

        function addOptionToForm(text, correct, index) {
            const container = document.getElementById('optionsContainer');
            const optionDiv = document.createElement('div');
            optionDiv.className = 'option-row';
            optionDiv.innerHTML = `
                <input type="text" class="form-control" placeholder="Текст ответа" value="${text}">
                <div style="display: flex; align-items: center; gap: 5px;">
                    <input type="radio" name="correctOption" ${correct ? 'checked' : ''} value="${index}">
                    <span>Правильный</span>
                </div>
                <button type="button" class="btn btn-danger btn-small" onclick="removeOption(this)">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(optionDiv);
        }

        function removeOption(button) {
            if (document.querySelectorAll('.option-row').length <= 2) {
                showStatus('Должно быть минимум 2 варианта', 'error');
                return;
            }
            button.closest('.option-row').remove();
        }

        function addNewQuestion() {
            document.getElementById('questionSelect').value = '';
            clearQuestionForm();
        }

        function saveQuestion() {
            const themeId = document.getElementById('questionTheme').value;
            const questionSelect = document.getElementById('questionSelect');
            const questionIndex = questionSelect.value;
            const questionText = document.getElementById('editQuestionText').value.trim();
            let questionImage = document.getElementById('editQuestionImage').value.trim();
            const questionInfo = document.getElementById('editQuestionInfo').value.trim();
            
            if (!themeId) {
                showStatus('Выберите тему', 'error');
                return;
            }
            
            if (!questionText) {
                showStatus('Введите текст вопроса', 'error');
                return;
            }
            
            questionImage = fixImageUrl(questionImage);
            
            const options = [];
            document.querySelectorAll('.option-row').forEach(row => {
                const textInput = row.querySelector('input[type="text"]');
                const radioInput = row.querySelector('input[type="radio"]');
                
                if (textInput && radioInput) {
                    const text = textInput.value.trim();
                    const correct = radioInput.checked;
                    
                    if (text) {
                        options.push({ text, correct });
                    }
                }
            });
            
            if (options.length < 2) {
                showStatus('Добавьте минимум 2 варианта', 'error');
                return;
            }
            
            const hasCorrectAnswer = options.some(opt => opt.correct);
            if (!hasCorrectAnswer) {
                showStatus('Отметьте правильный ответ', 'error');
                return;
            }
            
            const question = {
                question: questionText,
                image: questionImage,
                info: questionInfo,
                options: options
            };
            
            if (!appData.quizzes[themeId]) {
                const theme = appData.themes.find(t => t.id === themeId);
                appData.quizzes[themeId] = {
                    type: 'quiz',
                    name: theme?.name || 'Новая тема',
                    questions: []
                };
            }
            
            let newQuestionIndex;
            
            if (questionIndex !== '' && questionIndex !== null) {
                const index = parseInt(questionIndex);
                if (index >= 0 && index < appData.quizzes[themeId].questions.length) {
                    appData.quizzes[themeId].questions[index] = question;
                    newQuestionIndex = index;
                    showStatus('Вопрос обновлен!', 'success');
                } else {
                    showStatus('Некорректный индекс вопроса', 'error');
                    return;
                }
            } else {
                if (!appData.quizzes[themeId].questions) {
                    appData.quizzes[themeId].questions = [];
                }
                appData.quizzes[themeId].questions.push(question);
                newQuestionIndex = appData.quizzes[themeId].questions.length - 1;
                showStatus('Вопрос добавлен!', 'success');
            }
            
            if (saveData()) {
                loadQuestionsForTheme();
                setTimeout(() => {
                    document.getElementById('questionSelect').value = newQuestionIndex;
                    loadQuestionForm(themeId, newQuestionIndex);
                }, 100);
            }
        }

        function deleteQuestion() {
            const themeId = document.getElementById('questionTheme').value;
            const questionIndex = document.getElementById('questionSelect').value;
            
            if (!themeId || questionIndex === '' || questionIndex === null) return;
            
            if (!confirm('Удалить этот вопрос?')) return;
            
            const index = parseInt(questionIndex);
            if (appData.quizzes[themeId] && appData.quizzes[themeId].questions[index]) {
                appData.quizzes[themeId].questions.splice(index, 1);
                
                if (saveData()) {
                    loadQuestionsForTheme();
                    clearQuestionForm();
                    showStatus('Вопрос удален', 'success');
                }
            }
        }

        // ============ РЕДАКТИРОВАНИЕ ЛОКАЦИЙ ============
        function loadLocationsForTheme() {
            const themeId = document.getElementById('locationTheme').value;
            const select = document.getElementById('locationSelect');
            select.innerHTML = '<option value="">-- Новая локация --</option>';
            
            if (!themeId || !appData.photoTours[themeId]) return;
            
            const locations = appData.photoTours[themeId].locations || [];
            locations.forEach((loc, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `Локация ${index + 1}: ${loc.name}`;
                select.appendChild(option);
            });
            
            select.addEventListener('change', function() {
                if (this.value !== '') {
                    loadLocationForm(themeId, parseInt(this.value));
                } else {
                    clearLocationForm();
                }
            });
        }

        function loadLocationForm(themeId, locationIndex) {
            if (!appData.photoTours[themeId] || !appData.photoTours[themeId].locations[locationIndex]) {
                showStatus('Локация не найдена', 'error');
                return;
            }
            
            const location = appData.photoTours[themeId].locations[locationIndex];
            
            document.getElementById('editLocationName').value = location.name;
            document.getElementById('editLocationImage').value = location.image || '';
            document.getElementById('editLocationDesc').value = location.description || '';
            document.getElementById('editLocationYear').value = location.year || '';
            document.getElementById('editLocationFunFact').value = location.funFact || '';
            
            document.getElementById('deleteLocationBtn').style.display = 'block';
        }

        function clearLocationForm() {
            document.getElementById('locationSelect').value = '';
            document.getElementById('editLocationName').value = '';
            document.getElementById('editLocationImage').value = '';
            document.getElementById('editLocationDesc').value = '';
            document.getElementById('editLocationYear').value = '';
            document.getElementById('editLocationFunFact').value = '';
            
            document.getElementById('deleteLocationBtn').style.display = 'none';
        }

        function addNewLocation() {
            document.getElementById('locationSelect').value = '';
            clearLocationForm();
        }

        function saveLocation() {
            const themeId = document.getElementById('locationTheme').value;
            const locationSelect = document.getElementById('locationSelect');
            const locationIndex = locationSelect.value;
            const name = document.getElementById('editLocationName').value.trim();
            let image = document.getElementById('editLocationImage').value.trim();
            const description = document.getElementById('editLocationDesc').value.trim();
            const year = document.getElementById('editLocationYear').value.trim();
            const funFact = document.getElementById('editLocationFunFact').value.trim();
            
            if (!themeId) {
                showStatus('Выберите тему', 'error');
                return;
            }
            
            if (!name) {
                showStatus('Введите название локации', 'error');
                return;
            }
            
            if (!description) {
                showStatus('Введите описание локации', 'error');
                return;
            }
            
            image = fixImageUrl(image);
            
            const location = {
                name,
                image,
                description,
                year,
                funFact
            };
            
            if (!appData.photoTours[themeId]) {
                const theme = appData.themes.find(t => t.id === themeId);
                appData.photoTours[themeId] = {
                    type: 'photo',
                    name: theme?.name || 'Новая тема',
                    locations: []
                };
            }
            
            let newLocationIndex;
            
            if (locationIndex !== '' && locationIndex !== null) {
                const index = parseInt(locationIndex);
                if (index >= 0 && index < appData.photoTours[themeId].locations.length) {
                    appData.photoTours[themeId].locations[index] = location;
                    newLocationIndex = index;
                    showStatus('Локация обновлена!', 'success');
                } else {
                    showStatus('Некорректный индекс локации', 'error');
                    return;
                }
            } else {
                appData.photoTours[themeId].locations.push(location);
                newLocationIndex = appData.photoTours[themeId].locations.length - 1;
                showStatus('Локация добавлена!', 'success');
            }
            
            if (saveData()) {
                loadLocationsForTheme();
                setTimeout(() => {
                    document.getElementById('locationSelect').value = newLocationIndex;
                    loadLocationForm(themeId, newLocationIndex);
                }, 100);
                
                updateThemesUI();
            }
        }

        function deleteLocation() {
            const themeId = document.getElementById('locationTheme').value;
            const locationIndex = document.getElementById('locationSelect').value;
            
            if (!themeId || locationIndex === '' || locationIndex === null) return;
            
            if (!confirm('Удалить эту локацию?')) return;
            
            const index = parseInt(locationIndex);
            if (appData.photoTours[themeId] && appData.photoTours[themeId].locations[index]) {
                appData.photoTours[themeId].locations.splice(index, 1);
                
                if (saveData()) {
                    loadLocationsForTheme();
                    clearLocationForm();
                    showStatus('Локация удалена', 'success');
                    
                    updateThemesUI();
                }
            }
        }

        // ============ РЕДАКТИРОВАНИЕ ВИДЕО ============
        function loadVideosForTheme() {
            const themeId = document.getElementById('videoTheme').value;
            const select = document.getElementById('videoSelect');
            select.innerHTML = '<option value="">-- Новое видео --</option>';
            
            if (!themeId || !appData.videoTours[themeId]) return;
            
            const videos = appData.videoTours[themeId].videos || [];
            videos.forEach((video, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `Видео ${index + 1}: ${video.title}`;
                select.appendChild(option);
            });
            
            select.addEventListener('change', function() {
                if (this.value !== '') {
                    loadVideoForm(themeId, parseInt(this.value));
                } else {
                    clearVideoForm();
                }
            });
        }

        function loadVideoForm(themeId, videoIndex) {
            if (!appData.videoTours[themeId] || !appData.videoTours[themeId].videos[videoIndex]) {
                showStatus('Видео не найдено', 'error');
                return;
            }
            
            const video = appData.videoTours[themeId].videos[videoIndex];
            
            document.getElementById('editVideoTitle').value = video.title;
            document.getElementById('editVideoUrl').value = video.url || '';
            document.getElementById('editVideoDescription').value = video.description || '';
            document.getElementById('editVideoYear').value = video.year || '';
            document.getElementById('editVideoDuration').value = video.duration || 5;
            
            document.getElementById('deleteVideoBtn').style.display = 'block';
        }

        function clearVideoForm() {
            document.getElementById('videoSelect').value = '';
            document.getElementById('editVideoTitle').value = '';
            document.getElementById('editVideoUrl').value = '';
            document.getElementById('editVideoDescription').value = '';
            document.getElementById('editVideoYear').value = '';
            document.getElementById('editVideoDuration').value = 5;
            
            document.getElementById('deleteVideoBtn').style.display = 'none';
        }

        function addNewVideo() {
            document.getElementById('videoSelect').value = '';
            clearVideoForm();
        }

        function saveVideo() {
            const themeId = document.getElementById('videoTheme').value;
            const videoSelect = document.getElementById('videoSelect');
            const videoIndex = videoSelect.value;
            const title = document.getElementById('editVideoTitle').value.trim();
            let url = document.getElementById('editVideoUrl').value.trim();
            const description = document.getElementById('editVideoDescription').value.trim();
            const year = document.getElementById('editVideoYear').value.trim();
            const duration = parseInt(document.getElementById('editVideoDuration').value) || 5;
            
            if (!themeId) {
                showStatus('Выберите тему', 'error');
                return;
            }
            
            if (!title) {
                showStatus('Введите название видео', 'error');
                return;
            }
            
            if (!url) {
                showStatus('Введите ссылку на видео', 'error');
                return;
            }
            
            if (!description) {
                showStatus('Введите описание видео', 'error');
                return;
            }
            
            url = fixVideoUrl(url);
            
            const video = {
                title,
                url,
                description,
                year,
                duration
            };
            
            if (!appData.videoTours[themeId]) {
                const theme = appData.themes.find(t => t.id === themeId);
                appData.videoTours[themeId] = {
                    type: 'video',
                    name: theme?.name || 'Новая тема',
                    videos: []
                };
            }
            
            let newVideoIndex;
            
            if (videoIndex !== '' && videoIndex !== null) {
                const index = parseInt(videoIndex);
                if (index >= 0 && index < appData.videoTours[themeId].videos.length) {
                    appData.videoTours[themeId].videos[index] = video;
                    newVideoIndex = index;
                    showStatus('Видео обновлено!', 'success');
                } else {
                    showStatus('Некорректный индекс видео', 'error');
                    return;
                }
            } else {
                appData.videoTours[themeId].videos.push(video);
                newVideoIndex = appData.videoTours[themeId].videos.length - 1;
                showStatus('Видео добавлено!', 'success');
            }
            
            if (saveData()) {
                loadVideosForTheme();
                setTimeout(() => {
                    document.getElementById('videoSelect').value = newVideoIndex;
                    loadVideoForm(themeId, newVideoIndex);
                }, 100);
                
                updateThemesUI();
            }
        }

        function deleteVideo() {
            const themeId = document.getElementById('videoTheme').value;
            const videoIndex = document.getElementById('videoSelect').value;
            
            if (!themeId || videoIndex === '' || videoIndex === null) return;
            
            if (!confirm('Удалить это видео?')) return;
            
            const index = parseInt(videoIndex);
            if (appData.videoTours[themeId] && appData.videoTours[themeId].videos[index]) {
                appData.videoTours[themeId].videos.splice(index, 1);
                
                if (saveData()) {
                    loadVideosForTheme();
                    clearVideoForm();
                    showStatus('Видео удалено', 'success');
                    
                    updateThemesUI();
                }
            }
        }

        // ============ РЕДАКТИРОВАНИЕ ИСТОРИИ ============
        function loadHistoryForm() {
            document.getElementById('editHistoryTitle').value = appData.history.title;
            
            const factsContainer = document.getElementById('historyFactsContainer');
            factsContainer.innerHTML = '';
            
            appData.history.facts.forEach((fact, index) => {
                addHistoryFactToForm(fact.title, fact.content, index);
            });
            
            const timelineContainer = document.getElementById('historyTimelineContainer');
            timelineContainer.innerHTML = '';
            
            appData.history.timeline.forEach((event, index) => {
                addTimelineEventToForm(event.year, event.event, index);
            });
        }

        function addHistoryFact() {
            const container = document.getElementById('historyFactsContainer');
            const index = container.children.length;
            addHistoryFactToForm('', '', index);
        }

        function addHistoryFactToForm(title, content, index) {
            const container = document.getElementById('historyFactsContainer');
            const factDiv = document.createElement('div');
            factDiv.className = 'option-row';
            factDiv.innerHTML = `
                <input type="text" class="form-control" placeholder="Заголовок" value="${title}">
                <input type="text" class="form-control" placeholder="Содержание" value="${content}">
                <button type="button" class="btn btn-danger btn-small" onclick="removeHistoryFact(this)">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(factDiv);
        }

        function removeHistoryFact(button) {
            button.closest('.option-row').remove();
        }

        function addTimelineEvent() {
            const container = document.getElementById('historyTimelineContainer');
            const index = container.children.length;
            addTimelineEventToForm('', '', index);
        }

        function addTimelineEventToForm(year, event, index) {
            const container = document.getElementById('historyTimelineContainer');
            const eventDiv = document.createElement('div');
            eventDiv.className = 'option-row';
            eventDiv.innerHTML = `
                <input type="text" class="form-control" placeholder="Год" value="${year}">
                <input type="text" class="form-control" placeholder="Событие" value="${event}">
                <button type="button" class="btn btn-danger btn-small" onclick="removeTimelineEvent(this)">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(eventDiv);
        }

        function removeTimelineEvent(button) {
            button.closest('.option-row').remove();
        }

        function saveHistory() {
            appData.history.title = document.getElementById('editHistoryTitle').value.trim();
            
            appData.history.facts = [];
            document.querySelectorAll('#historyFactsContainer .option-row').forEach(row => {
                const inputs = row.querySelectorAll('input');
                const title = inputs[0].value.trim();
                const content = inputs[1].value.trim();
                
                if (title && content) {
                    appData.history.facts.push({ title, content });
                }
            });
            
            appData.history.timeline = [];
            document.querySelectorAll('#historyTimelineContainer .option-row').forEach(row => {
                const inputs = row.querySelectorAll('input');
                const year = inputs[0].value.trim();
                const event = inputs[1].value.trim();
                
                if (year && event) {
                    appData.history.timeline.push({ year, event });
                }
            });
            
            if (saveData()) {
                updateHistoryUI();
                showStatus('История сохранена!', 'success');
            }
        }

        // ============ ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ============
        function clearAppCache() {
            if (confirm('Очистить весь кэш приложения? Все данные будут сброшены к начальным значениям.')) {
                localStorage.removeItem('chelny_app_data');
                localStorage.removeItem('chelny_visited_locations');
                localStorage.removeItem('chelny_watched_videos');
                localStorage.removeItem('chelny_best_score');
                localStorage.removeItem('chelny_dark_theme');
                localStorage.removeItem('chelny_optimized_mode');
                location.reload();
            }
        }

        // Глобальные функции
        window.startTheme = startTheme;
        window.showThemes = showThemes;
        window.startPhotoTour = startPhotoTour;
        window.startVideoTour = startVideoTour;
        window.selectOption = selectOption;
        window.checkAnswer = checkAnswer;
        window.nextQuestion = nextQuestion;
        window.finishQuiz = finishQuiz;
        window.prevQuestion = prevQuestion;
        window.prevLocation = prevLocation;
        window.nextLocation = nextLocation;
        window.prevVideo = prevVideo;
        window.nextVideo = nextVideo;
        window.restartQuiz = restartQuiz;
        window.restartPhotoTour = restartPhotoTour;
        window.restartVideoTour = restartVideoTour;
        window.showTourMap = showTourMap;
        window.closeTourMap = closeTourMap;
        window.goToLocation = goToLocation;
        window.openEditModal = openEditModal;
        window.closeEditModal = closeEditModal;
        window.addOption = addOption;
        window.removeOption = removeOption;
        window.addHistoryFact = addHistoryFact;
        window.removeHistoryFact = removeHistoryFact;
        window.addTimelineEvent = addTimelineEvent;
        window.removeTimelineEvent = removeTimelineEvent;
        window.saveTheme = saveTheme;
        window.deleteTheme = deleteTheme;
        window.addNewTheme = addNewTheme;
        window.saveQuestion = saveQuestion;
        window.deleteQuestion = deleteQuestion;
        window.addNewQuestion = addNewQuestion;
        window.saveLocation = saveLocation;
        window.deleteLocation = deleteLocation;
        window.addNewLocation = addNewLocation;
        window.saveVideo = saveVideo;
        window.deleteVideo = deleteVideo;
        window.addNewVideo = addNewVideo;
        window.saveHistory = saveHistory;
        window.toggleOptimizedMode = toggleOptimizedMode;
        window.toggleFact = toggleFact;
        window.testImage = testImage;
        window.testVideo = testVideo;
        window.openFullscreenVideo = openFullscreenVideo;
        window.exitFullscreenVideo = exitFullscreenVideo;
        window.fixImageUrl = fixImageUrl;
        window.clearAppCache = clearAppCache;
        window.openBackupModal = openBackupModal;
        window.closeBackupModal = closeBackupModal;
        window.toggleImportSection = toggleImportSection;
        window.handleBackupFileSelect = handleBackupFileSelect;
        window.downloadBackup = downloadBackup;
        window.restoreFromBackup = restoreFromBackup;
    </script>
</body>
</html>
